# 内网工作环境

## 工作组

在一个大的单位内，可能有成百上千台计算机互相连接组成局域网，它们都会列在“网络”（网

上邻居）内。如果这些计算机不分组，情况会有多么混乱是可想而知的——很难找一台计算机。为

了解决这一问题，就有了**工作组**（Work Group）这个概念。将不同的计算机按功能（或部门）分

别列入不同的工作组中，如技术部的计算机都列入“技术部”工作组中，行政部的计算机都列入

“行政部”工作组中。要想访问某个部门的资源，只要在“网络”里找到那个部门的工作组名并

双击，就可以看到那个部门的所有计算机了。相比不分组的情况，这样的情况有序得多（尤其是

对大型局域网络来说）。处在同一交换机下的“技术部”工作和“行政部”工作，

![Untitled](%E5%86%85%E7%BD%91%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83%20f6e0feb93ff24057a1c98661b855c855/Untitled.png)

# 域

## 域（Domain）

域是一个有安全边界的计算机集合（安全边界：在两个域中，一个域中的用户无法访问另一个域中的资源），可以将域理解为升级版的工作组。相比工作组，域有着更加严格的安全管理控制机制。要想访问域内的资源，用户必须通过合法的身份登录域，而用户对域内的资源拥有什么样的权限，取决于他在域内的身份

## 域控制器（Domain Controller，DC）

域控制器是域内的一台类似于管理服务器的计算机，负责每一台联入的计算机和用户的验证工作。域内的计算机如果想要互相访问，都要先经过域控制器的审核

域控制器包含这个域的账户、密码、属于这个域的计算机等信息构成的数据库，当有计算机联入，域控制器对计算机是否属于这个域和账号是否存在，密码是否正确

> 渗透域的最终目的是获取域控的系统权限，进而获取域内所有用户的账号和密码。
> 

## 域内环境

### 单域

一般一个域内要建立至少两个域服务器，一个作为DC，另一个作为备份DC。如果没有备份DC，那么一旦DC瘫痪，域内的其他用户就无法登录该域了，因为活动目录的数据库（包括用户的账号信息）是存储在 DC 中的。如果有一台备份域控制器（BDC），则至少该域还能正常使用（把瘫痪的 DC 恢复即可）

### 父域与子域

出于管理及其他需求，需要在网络中划分多个域。第一个域称为父域，各分部的域称为该域
的子域。例如，一个大公司的不同分公司位于不同的地理位置，就需要父域及子域这样的结构。
如果把不同地理位置的分公司放在同一个域内，那么它们之间信息交互（包括同步、复制等）所
花费的时间就会比较长，占用的带宽也会比较大（因为在同一个域内，信息交互的条目是很多的，
而且不压缩；而在域和域之间，信息交互的条目相对较少，而且可以压缩）。这样处理还有一个好
处，就是子公司可以通过自己的域来管理自己的资源。还有一种情况，就是出于安全策略的考虑
（每个域都有自己独有的安全策略）。例如，一个公司的财务部门希望能使用特定的安全策略（包
括账号密码策略等），那么可以将财务部门作为一个子域来单独管理。

### 域树

域树（Tree）指若干个域通过建立信任关系而组成的集合。一个域管理员只能管理本域的内
部，不能访问或者管理其他域，两个域之间相互访问则需要建立信任关系（Trust Relation）。信任
关系是连接不同域的桥梁。域树内的父域与子域之间不但可以按照需要相互进行管理，还可以跨
网分配文件和打印机等设备资源，从而在不同的域之间实现网络资源的共享与管理、通信和数据
传输。

在一个域树中，父域可以包含很多个子域。子域是相对父域来说的，是指域名中的每一个段。
各子域之间用点号隔开，一个“.”代表一个层次。放在域名最后的子域称为最高级子域或一级域，在它前面的子域称为二级域。例如，域 [asia.abc.com](http://asia.abc.com/) 就比域 [abc.com](http://abc.com/) 的级别低，因为域 [asia.abc.com](http://asia.abc.com/)有两个层次，而域 [abc.com](http://abc.com/) 只有一个层次。再如，域 [cn.asia.abc.com](http://cn.asia.abc.com/) 比域 [asia.abc.com](http://asia.abc.com/) 的级别低。可以看出，子域只能使用父域作为域名的后缀，也就是说，在一个域树中，域的名字是连续的

![Untitled](%E5%86%85%E7%BD%91%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83%20f6e0feb93ff24057a1c98661b855c855/Untitled%201.png)

### 域森林

域森林（Forest）是指若干个域树通过建立信任关系组成的集合。例如，在一个公司兼并场景
中，该公司使用域树 [abc.com](http://abc.com/)，被兼并公司本来有自己的域树 [abc.net](http://abc.net/)（或者在需要为被兼并公司
建立具有自己特色的域树时），因为域树 [abc.net](http://abc.net/) 无法挂在域树 [abc.com](http://abc.com/) 下，则域树 [abc.com](http://abc.com/) 与域
树 [abc.net](http://abc.net/) 之间需要通过建立信任关系来构成域森林。这样，通过在域树之间建立的信任关系，就
可以管理和使用整个域森林中的资源，并保留被兼并公司自身原有的特性

![Untitled](%E5%86%85%E7%BD%91%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83%20f6e0feb93ff24057a1c98661b855c855/Untitled%202.png)

### 域名服务器

域名服务器（Domain Name Server，DNS）是指用于进行域名（Domain Name）和与之相对应的 IP 地址（IP Address）转换的服务器。从对域树的介绍中可以看出，域树中的域的名字和 DNS域的名字非常相似，而实际上，因为域中的计算机是使用 DNS 来定位域控制器、服务器及其他计算机、网络服务等的，所以域的名字就是 DNS 域的名字。一般在进行内网渗透时就是通过寻找DNS 服务器来定位域控制器的（DNS 服务器和域控制器通常会处在同一台机器上）。

## 活动目录**（Active Directory，AD）**

**活动目录（Active Directory，AD）**是指域环境中提供目录服务的组件

目录就是存储有关网络对象（如用户、组、计算机、共享资源、打印机和联系人等）的信息。目录服务是指帮助用户快速、准确地从目录中找到其所需要的信息的服务。活动目录实现了目录服务，为企业提供了网络环境的集中式管理机制

在活动目录中，管理员可以完全忽略被管理对象的具体地理位置，而将这些对象按照一定的方式放置在不同的容器中。由于这种组织对象的做法不考虑被管理对象的具体地理位置，这种组织框架称为**逻辑结构**

活动目录的逻辑结构包括上面讲到的**组织单元**（OU）、**域**、**域树**、**域森林**。域树内的所有域共享一个活动目录，这个活动目录内的数据分散地存储在各个域内，且每个域只存储该域内的数据。

### 功能

- 账号集中管理：所有账号均存储在服务器上，以便对账号进行重置命令/重置密码等。
- 软件集中管理：统一推送软件、安装网络打印机等。利用软件发布策略分发软件，可以让
用户自由选择要安装的软件。
- 环境集中管理：统一客户端桌面、IE、TCP/IP 协议等的设置
- 增强安全性：统一部署杀毒软件和扫毒任务、集中管理用户的计算机权限、统一制订用户
密码策略等。可以监控网络，对资料进行统一管理。
- 更可靠，更短的宕机时间：例如，利用活动目录控制用户访问权限，利用群集、负载均衡
等技术对文件服务器进行容灾设定。更可靠，宕机时间更短。

### 域控制器和活动目录的区别

域控制器（DC）与活动目录（AD）最大的区别是：如果网络规模较大，就考虑把网络中的众多对象，如计算机、用户、用户组、打印机、共享文件等，分门别类、井然有序地放在一个大仓库中，并将检索信息整理好，以便查找、管理和使用这些对象（资源）。这个拥有层次结构的数据库，就是活动目录数据库，简称 AD 库

用于存储活动目录数据库的计算机称为DC。所以，要实现域环境，其实就是要安装 AD。当内网中的一台计算机上安装了 AD，它就变成了 DC

### 安全域的划分

划分安全域的目的是将一组安全等级相同的计算机划入同一个网段，这一网段内的计算机拥有相同的网络边界，在网络边界上通过部署防火墙来实现对其他安全域的网络访问控制策略（NACL），从而规定允许哪些 IP 地址访问此域和不允许哪些 IP 地址访问此域、允许此域访问哪些 IP 地址/网段和不允此域许访问哪些 IP 地址/网段。这些措施，将使得网络风险最小化，当发生攻击时，可以将威胁尽可能地隔离，从而减少对域内计算机的影响

**DMZ** 称为隔离区（也称“非军事化区”），是为了解决安装防火墙后外部网络不能访问内部网络服务器的问题而设立的一个非安全系统与安全系统之间的缓冲区。这个缓冲区位于企业内部网络和外部网络之间的小网络区域内。在这个小网络区域内，可以放置一些必须公开的服务器设施，如企业 Web 服务器、FTP 服务器和论坛等。因为 DMZ 区是对外提供服务的区域，所以可以从外部访问

**通常的DMZ区域访问控制**

- 内网可以访问外网：内网用户需要自由地访问外网。在这一策略中，防火墙需要执行 NAT
- 内网可以访问 DMZ：此策略使内网用户可以使用或者管理 DMZ 中的服务器
- 外网不能访问内网：这是防火墙的基本策略。内网中存放的是公司内部数据，显然这些数
据是不允许外网用户访问的。如果要访问，就要通过 VPN 方式来进行
- 外网可以访问DMZ：DMZ中的服务器需要为外界提供服务，所以外网必须可以访问DMZ。
同时，外网访问 DMZ 需要由防火墙来完成从对外地址到服务器实际地址的转换
- DMZ 不能访问内网：如果不执行此策略，当入侵者攻陷 DMZ 时，内网将不会受到保护
- DMZ 不能访问外网：此策略也有例外，如在 DMZ 中放置邮件服务器时，就需要访问外网，
否则将不能正常工作

### 域中计算机分类

**************************域控制器**************************

域控制器用于管理所有的网络访问，包括登录服务器、访问共享目录和资源。域控制器中存储了域范围内所有的账户和策略信息，包括安全策略、用户身份验证信息和账户信息

在网络中，可以有多台计算机被配置为域控制器，以分担用户的登录和访问操作。多个域控制器可以一起工作，自动备份用户账户和活动目录数据。这样，即使部分域控制器瘫痪，网络访问仍然不受影响，从而提高网络的安全性和稳定性

**成员服务器**

成员服务器是指安装了服务器系统且加入了域、但没有安装活动目录的计算机，其主要任务是提供网络资源。成员服务器通常有以下类型：文件服务器、应用服务器、数据库服务器、Web 服务器、邮件服务器、防火墙、远程访问服务器、打印服务器等

**客户机**

域中的计算机可以是安装了其他操作系统的计算机，用户利用这些计算机和域中的账户就可以登录域（称为域中的客户机）。域用户账号通过域的安全验证后，即可访问网络中的各种资源

****************独立服务器****************

域中的计算机可以是安装了其他操作系统的计算机，用户利用这些计算机和域中的账户就可以登录域（称为域中的客户机）。域用户账号通过域的安全验证后，即可访问网络中的各种资源

域控制器用于存放活动目录数据库，是域中必须要有的，而其他三种计算机则不是必须要有的。也就是说，最简单的域可以只包含一台计算机，这台计算机就是该域的域控制器。当然，域中各服务器的角色是可以改变的。例如，域服务器在删除活动目录时，如果是域中的最后一个域控制器，则该域服务器会成为独立服务器，如果不是域中唯一的域控制器，则该服务器将成为成员服务器。独立服务器既可以转换为域控制器，也可以加入某个域，成为成员服务器

### 域内权限

**组**（Group）是用户账号的集合。通过向一组用户分配权限，就可以不必向每个用户分别分配权限。例如，管理员在日常工作中，不必为单个用户账号设置独特的访问权限，而将用户账号放到相对应的安全组中即可。管理员通过配置安全组访问权限，就可以为所有加入安全组的用户账户配置同样的权限。使用安全组而不是单个的用户账号，可以大大简化网络的维护和管理工作

********************域本地组********************

多域用户访问单域资源（访问同一个域），可以从任何域添加用户账户、通用组和全局组，但
只能在其所在域内指派权限。域本地组不能嵌套于其他组中。域本地组主要用于授予位于本域资
源的访问权限。

**全局组**

 单域用户访问多域资源（必须是同一个域里面的用户），只能在创建该全局组的域上进行添加用户和全局组，可以在域森林中的任何域中指派权限。全局组可以嵌套在其他组中

可以将某个全局组添加到同一个域上的另一个全局组中，或者添加到其他域的通用组和域本地组中（不能添加到不同域的全局组中，全局组只能在创建它的域中添加用户和组）。虽然可以通过全局组授予用户访问任何域内资源的权限，但一般不直接用它来进行权限管理

全局组和域本地组的关系，与域用户账号和本地账号的关系非常相似。域用户账号可以在全局使用，即在本域和其他关系的其他域中都可以使用，而本地账号只能在本地机上使用。例如，将用户张三（域账号为 Z3）添加到域本地组 administrators 中，并不能使 Z3 对非 DC 的域成员计算机拥有任何特权，但若将 Z3 添加到全局组 Domain Admins 中，用户张三就成为域管理员了（可以在全局使用，对域成员计算机拥有特权）

********通用组********

通用组成员来自域森林中任何域的用户账户、全局组和其他通用组，可以在该域森林的任何域中指派权限，可以嵌套于其他域组中，非常适于域森林中的跨域访问。

但是，通用组的成员不是保存在各自的域控制器上的，而是保存在全局编录（GC）中的，任何变化的发生都会导致全林复制。全局编录一般存储一些不经常发生变化的信息。由于用户账户是会经常变化的，建议不要直接将用户账户添加到通用组中，而要先将账户添加到全局组中，再把这些相对稳定的全局组添加到通用组中

********************A-G-DL-P策略********************

将用户账号添加到全局组中，将全局组添加到域本地组中，然后为域本
地组分配资源权限

- A 用户账号
- G 全局组
- U 通用组
- DL 域本地组
- P 资源权限