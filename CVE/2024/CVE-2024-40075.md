

## 漏洞分析
`routes/web.php`添加反序列化利用点

```PHP
Route::get("/vul", function (\Illuminate\Http\Request $request) {  
    $str = $request->input("data");  
    unserialize(base64_decode($str));;  
});
```


`vendor/monolog/monolog/src/Monolog/Handler/Handler.php#__destruct()`
该类为abstract抽象类
```PHP
abstract class Handler implements HandlerInterface  
{
	...
	public function __destruct()  
	{  
	    try {  
	        $this->close();  
	    } catch (\Throwable $e) {  
	        // do nothing  
	    }  
	}
	...
}
```
实现类
![](attachments/Pasted%20image%2020241014222431.png)

`vendor/monolog/monolog/src/Monolog/Handler/GroupHandler.php#close()`
GroupHandler对象实例销毁后，调用抽象类的`__destruct`，抽象类close()方法的使用实质调用了其自身的close()方法
```PHP
class GroupHandler extends Handler implements ProcessableHandlerInterface, ResettableInterface  
{  
    use ProcessableHandlerTrait;  
  
    /** @var HandlerInterface[] */  
    protected array $handlers;  
    protected bool $bubble;
    ...
    public function close(): void  
	{  
	    parent::close();  
  
	    foreach ($this->handlers as $handler) {  
	        $handler->close();  
	    }  
	}
	...
}
```

`vendor/psy/psysh/src/Readline/Hoa/Stream.php`
仍为abstract抽象类，选择实现类为FileRead，也就是说等同于`$this->handlers = new FileRead()`，执行`$streamName = $this->getStreamName();`后一直到md5函数的执行，此时`$streamName`为对象时，触发该对象的`__toString`魔术方法

```PHP
abstract class Stream implements IStream, EventListenable  
{  
    use EventListens;
    final public function close()  
	{  
	    $streamName = $this->getStreamName();  
	  
	    if (null === $streamName) {  
	        return;  
	    }  
	  
	    $name = \md5($streamName);  
	  
	    if (!isset(self::$_register[$name])) {  
	        return;  
	    }  
	  
	    Event::notify(  
	        'hoa://Event/Stream/'.$streamName.':close-before',  
	        $this,  
	        new EventBucket()  
	    );  
	  
	    if (false === $this->_close()) {  
	        return;  
	    }  
  
	    unset(self::$_register[$name]);  
	    $this->_bucket[self::HANDLER] = null;  
	    Event::unregister(  
	        'hoa://Event/Stream/'.$streamName  
	    );  
	    Event::unregister(  
	        'hoa://Event/Stream/'.$streamName.':close-before'  
	    );  
	  
	    return;  
	}
}    
```

`getStreamName()`

```PHP
public function getStreamName()  
{  
    if (empty($this->_bucket)) {  
        return null;  
    }  
  
    return $this->_bucket[self::NAME];  
}
```

`vendor/nunomaduro/termwind/src/Components/Element.php`

```PHP
abstract class Element  
{
	public function toString(): string  
	{  
	    if (is_array($this->content)) {  
	        $inheritance = new InheritStyles();  
	        $this->content = implode('', $inheritance($this->content, $this->styles));  
	    }  
	  
	    return $this->styles->format($this->content);  
	}
}
```
## 参考文章
[Laravel v11.x PHP反序列化漏洞分析(CVE-2024-40075) - 先知社区 (aliyun.com)](https://xz.aliyun.com/t/15127?u_atoken=17d9b39bbb694baa47c8b8374fab155f&u_asig=1a0c399b17288961834678098e00a0)